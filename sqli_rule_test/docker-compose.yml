# WAF Test Environment for SQLi Rule Testing
# Uses ModSecurity + OWASP CRS with blocking mode
# GoTestWAF for automated testing with HTML reports

services:
  # WAF Container - ModSecurity with Nginx in blocking mode
  waf:
    container_name: waf-sqli-test
    image: owasp/modsecurity-crs:nginx@sha256:6dd9a8a24682b6910c423451dc93050fd38c810bf367a9b2dfc71f364aa7aa74
    user: root
    environment:
      # Core configuration
      BACKEND: http://backend:80
      PORT: "8080"
      SERVERNAME: waf-sqli-test
      
      # ModSecurity settings - BLOCKING MODE
      MODSEC_RULE_ENGINE: "On"
      MODSEC_RESP_BODY_ACCESS: "On"
      MODSEC_RESP_BODY_MIMETYPE: "text/plain text/html text/xml application/json"
      MODSEC_TMP_DIR: "/tmp"
      
      # Anomaly scoring - High security
      BLOCKING_PARANOIA: 4
      DETECTION_PARANOIA: 4
      
      # Logging
      ACCESSLOG: "/var/log/nginx/access.log"
      ERRORLOG: "/var/log/nginx/error.log"
      MODSEC_AUDIT_LOG: "/var/log/nginx/modsec_audit.log"
      MODSEC_AUDIT_LOG_FORMAT: Native
      MODSEC_AUDIT_LOG_TYPE: Serial
      LOGLEVEL: "info"
      
      # Test marker
      CRS_ENABLE_TEST_MARKER: 1
    volumes:
      # Mount SQLi rules from local rules/ directory
      # Uncomment to test with ORIGINAL rules:
      # - ./rules/REQUEST-941-APPLICATION-CUSTOM-ATTACK-SQL-INJECTION-ORIGINAL.conf:/etc/modsecurity.d/owasp-crs/rules/REQUEST-941-APPLICATION-CUSTOM-ATTACK-SQL-INJECTION.conf:ro
      # Testing with NEW (GENERALIZED) SQLi rules:
      - ./rules/REQUEST-942-APPLICATION-CUSTOM-ATTACK-SQLI-GENERALIZED.conf:/etc/modsecurity.d/owasp-crs/rules/REQUEST-942-APPLICATION-CUSTOM-ATTACK-SQLI-GENERALIZED.conf:ro
      # Logs
      - ./logs:/var/log/nginx:rw
    ports:
      - "8081:8080"
    depends_on:
      - backend
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - waf-sqli-network

  # Backend - Simple HTTP echo server
  backend:
    container_name: backend-sqli-test
    image: ghcr.io/coreruleset/albedo:0.2.0@sha256:bc9b7e4f83a5268ccd2b4d1d26e926b6324e20ff1d91281c339ad82e55f5bab2
    command: ["--port", "80"]
    networks:
      - waf-sqli-network

  # GoTestWAF - Automated WAF testing
  gotestwaf:
    container_name: gotestwaf-sqli-test
    image: wallarm/gotestwaf:latest
    command:
      - --url=http://waf:8080
      - --workers=5
      - --noEmailReport
      - --reportFormat=html
      - --reportPath=/reports
      - --reportName=sqli-rule-test-report
    volumes:
      - ./reports:/reports:rw
    depends_on:
      waf:
        condition: service_healthy
    networks:
      - waf-sqli-network

networks:
  waf-sqli-network:
    driver: bridge
