# ============================================================================
# OWASP CRS - Generalized SQL Injection Detection Rules
# Rule ID Range: 300000-300014
# ============================================================================
# Purpose: Structure-based SQLi detection with intelligent nested decoding
#
# Key Improvements over ID 100045-100065 (research team):
# 1. Generalized regex patterns (structure vs enumeration)
# 2. Triple-layer decoding (standard, nested Base64, mixed encoding)
# 3. SQL comment normalization (t:replaceComments)
# 4. Multi-database coverage (MySQL, MSSQL, PostgreSQL, SQLite)
# 5. Anomaly detection for suspicious encoding patterns
# 6. Correct log messages and score variables
#
# ============================================================================

# ----------------------------------------------------------------------------
# LAYER 0: CONFIGURATION VARIABLES
# ----------------------------------------------------------------------------

SecAction \
    "id:300000,\
    phase:1,\
    nolog,\
    pass,\
    t:none,\
    setvar:'tx.sqli_nested_decoding=1',\
    setvar:'tx.sqli_max_decode_depth=2',\
    setvar:'tx.sqli_encoding_anomaly_score=3'"

# ============================================================================
# LAYER 1: STANDARD DECODING + CORE SQLi DETECTION
# ============================================================================
# Single-layer decode with comprehensive SQL normalization
# Variables: REQUEST_URI, ARGS_GET, ARGS, REQUEST_HEADERS
# Key: Uses t:replaceComments to handle /**/ SQL comment obfuscation
# ============================================================================

# ----------------------------------------------------------------------------
# Rule 300001: SQLi Detection in REQUEST_URI (URL Path)
# ----------------------------------------------------------------------------
# Captures the last segment of URL path and checks for SQLi patterns
# Note: block/deny is in chain starter; chained rule just does pattern match

SecRule REQUEST_URI "@rx ^.*/([^/]+)$" \
    "id:300001,\
    phase:2,\
    block,\
    capture,\
    t:none,\
    setvar:'tx.sqli_urlpath_payload=%{TX.1}',\
    msg:'SQL Injection Attack Detected in URL Path (Layer 1)',\
    logdata:'Payload: %{TX.1}',\
    severity:CRITICAL,\
    tag:'attack-sqli',\
    tag:'paranoia-level/4',\
    tag:'OWASP_CRS/SQLI/GENERALIZED',\
    setvar:'tx.sql_injection_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}',\
    chain"

    SecRule TX:sqli_urlpath_payload "@rx (?i)(?:\bunion\s+(?:all\s+)?select\b|;\s*(?:select|insert|update|delete|drop|alter|create|truncate|exec)\b|\b(?:sleep|benchmark|pg_sleep|waitfor\s+delay)\s*\(|\b(?:extractvalue|updatexml)\s*\(|floor\s*\(\s*rand\s*\(|\bexec(?:ute)?\s+(?:master|xp_|sp_)|xp_cmdshell|\b(?:information_schema|sys(?:databases|objects|columns|tables))\b|\b(?:load_file|into\s+(?:out|dump)file|load\s+data\s+infile)\b|\bor\s+[\d'\"]+\s*=\s*[\d'\"]+|/\*[!+].*?\*/|\bjson_(?:extract|depth|length|type|valid|object|array|value)\s*\(|['\"](?:\s*(?:or|and)\s+['\"\d]|;)|\b(?:sqlite_master|pg_(?:catalog|sleep|user)|version|database)\s*\(|\bcopy\s+.*\s+(?:to|from)\s+program\b)" \
        "t:none,\
        t:urlDecodeUni,\
        t:base64Decode,\
        t:replaceComments,\
        t:htmlEntityDecode,\
        t:compressWhitespace,\
        t:lowercase"

# ----------------------------------------------------------------------------
# Rule 300002: SQLi Detection in ARGS_GET (URL Parameters)
# ----------------------------------------------------------------------------

SecRule ARGS_GET "@rx (?i)(?:\bunion\s+(?:all\s+)?select\b|;\s*(?:select|insert|update|delete|drop|alter|create|truncate|exec)\b|\b(?:sleep|benchmark|pg_sleep|waitfor\s+delay)\s*\(|\b(?:extractvalue|updatexml)\s*\(|floor\s*\(\s*rand\s*\(|\bexec(?:ute)?\s+(?:master|xp_|sp_)|xp_cmdshell|\b(?:information_schema|sys(?:databases|objects|columns|tables))\b|\b(?:load_file|into\s+(?:out|dump)file|load\s+data\s+infile)\b|\bor\s+[\d'\"]+\s*=\s*[\d'\"]+|/\*[!+].*?\*/|\bjson_(?:extract|depth|length|type|valid|object|array|value)\s*\(|['\"](?:\s*(?:or|and)\s+['\"\d]|;)|\b(?:sqlite_master|pg_(?:catalog|sleep|user)|version|database)\s*\(|\bcopy\s+.*\s+(?:to|from)\s+program\b)" \
    "id:300002,\
    phase:2,\
    t:none,\
    t:base64Decode,\
    t:replaceComments,\
    t:htmlEntityDecode,\
    t:compressWhitespace,\
    t:lowercase,\
    block,\
    msg:'SQL Injection Attack Detected in URL Parameters (Layer 1)',\
    logdata:'Parameter: %{MATCHED_VAR_NAME}, Payload: %{MATCHED_VAR}',\
    severity:CRITICAL,\
    tag:'attack-sqli',\
    tag:'paranoia-level/4',\
    tag:'OWASP_CRS/SQLI/GENERALIZED',\
    setvar:'tx.sql_injection_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}'"

# ----------------------------------------------------------------------------
# Rule 300003: SQLi Detection in ARGS (POST Body / Form Data / JSON)
# ----------------------------------------------------------------------------

SecRule ARGS "@rx (?i)(?:\bunion\s+(?:all\s+)?select\b|;\s*(?:select|insert|update|delete|drop|alter|create|truncate|exec)\b|\b(?:sleep|benchmark|pg_sleep|waitfor\s+delay)\s*\(|\b(?:extractvalue|updatexml)\s*\(|floor\s*\(\s*rand\s*\(|\bexec(?:ute)?\s+(?:master|xp_|sp_)|xp_cmdshell|\b(?:information_schema|sys(?:databases|objects|columns|tables))\b|\b(?:load_file|into\s+(?:out|dump)file|load\s+data\s+infile)\b|\bor\s+[\d'\"]+\s*=\s*[\d'\"]+|/\*[!+].*?\*/|\bjson_(?:extract|depth|length|type|valid|object|array|value)\s*\(|['\"](?:\s*(?:or|and)\s+['\"\d]|;)|\b(?:sqlite_master|pg_(?:catalog|sleep|user)|version|database)\s*\(|\bcopy\s+.*\s+(?:to|from)\s+program\b)" \
    "id:300003,\
    phase:2,\
    t:none,\
    t:base64Decode,\
    t:replaceComments,\
    t:htmlEntityDecode,\
    t:compressWhitespace,\
    t:lowercase,\
    block,\
    msg:'SQL Injection Attack Detected in POST/JSON Data (Layer 1)',\
    logdata:'Parameter: %{MATCHED_VAR_NAME}, Payload: %{MATCHED_VAR}',\
    severity:CRITICAL,\
    tag:'attack-sqli',\
    tag:'paranoia-level/4',\
    tag:'OWASP_CRS/SQLI/GENERALIZED',\
    setvar:'tx.sql_injection_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}'"

# ----------------------------------------------------------------------------
# Rule 300004: SQLi Detection in REQUEST_HEADERS (All Headers)
# ----------------------------------------------------------------------------

SecRule REQUEST_HEADERS "@rx (?i)(?:\bunion\s+(?:all\s+)?select\b|;\s*(?:select|insert|update|delete|drop|alter|create|truncate|exec)\b|\b(?:sleep|benchmark|pg_sleep|waitfor\s+delay)\s*\(|\b(?:extractvalue|updatexml)\s*\(|floor\s*\(\s*rand\s*\(|\bexec(?:ute)?\s+(?:master|xp_|sp_)|xp_cmdshell|\b(?:information_schema|sys(?:databases|objects|columns|tables))\b|\b(?:load_file|into\s+(?:out|dump)file|load\s+data\s+infile)\b|\bor\s+[\d'\"]+\s*=\s*[\d'\"]+|/\*[!+].*?\*/|\bjson_(?:extract|depth|length|type|valid|object|array|value)\s*\(|['\"](?:\s*(?:or|and)\s+['\"\d]|;)|\b(?:sqlite_master|pg_(?:catalog|sleep|user)|version|database)\s*\(|\bcopy\s+.*\s+(?:to|from)\s+program\b)" \
    "id:300004,\
    phase:2,\
    t:none,\
    t:urlDecodeUni,\
    t:base64Decode,\
    t:replaceComments,\
    t:htmlEntityDecode,\
    t:compressWhitespace,\
    t:lowercase,\
    block,\
    msg:'SQL Injection Attack Detected in HTTP Headers (Layer 1)',\
    logdata:'Header: %{MATCHED_VAR_NAME}, Payload: %{MATCHED_VAR}',\
    severity:CRITICAL,\
    tag:'attack-sqli',\
    tag:'paranoia-level/4',\
    tag:'OWASP_CRS/SQLI/GENERALIZED',\
    setvar:'tx.sql_injection_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}'"

# ============================================================================
# LAYER 2: NESTED BASE64 DETECTION
# ============================================================================
# Strategy: "Onion Peeling"
# 1. Check if value looks like Base64
# 2. Decode once → check if result is still Base64 (nested!)
# 3. Apply SQLi detection on double-decoded value
# ============================================================================

# ----------------------------------------------------------------------------
# Rule 300005: Nested Base64 in ARGS_GET
# ----------------------------------------------------------------------------

SecRule ARGS_GET "@rx ^[A-Za-z0-9+/]{16,}={0,2}$" \
    "id:300005,\
    phase:2,\
    block,\
    nolog,\
    t:none,\
    capture,\
    msg:'SQL Injection with Nested Base64 Encoding Detected (Layer 2) - URL Param',\
    logdata:'Double-decoded payload: %{MATCHED_VAR}',\
    severity:CRITICAL,\
    tag:'attack-sqli',\
    tag:'attack-encoding-evasion',\
    tag:'paranoia-level/4',\
    tag:'OWASP_CRS/SQLI/NESTED',\
    setvar:'tx.sqli_potential_nested_b64=%{MATCHED_VAR}',\
    setvar:'tx.sql_injection_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}',\
    setvar:'tx.sqli_encoding_anomaly_score=+2',\
    chain"

    SecRule TX:sqli_potential_nested_b64 "@rx ^[A-Za-z0-9+/]{16,}={0,2}$" \
        "t:base64Decode,\
        setvar:'tx.sqli_nested_decoded_once=%{MATCHED_VAR}',\
        chain"

        SecRule TX:sqli_nested_decoded_once "@rx (?i)(?:\bunion\s+(?:all\s+)?select\b|;\s*(?:select|insert|update|delete|drop|alter|create|truncate|exec)\b|\b(?:sleep|benchmark|pg_sleep|waitfor\s+delay)\s*\(|\b(?:extractvalue|updatexml)\s*\(|floor\s*\(\s*rand\s*\(|\bexec(?:ute)?\s+(?:master|xp_|sp_)|xp_cmdshell|\b(?:information_schema|sys(?:databases|objects|columns|tables))\b|\b(?:load_file|into\s+(?:out|dump)file|load\s+data\s+infile)\b|\bor\s+[\d'\"]+\s*=\s*[\d'\"]+|/\*[!+].*?\*/|\bjson_(?:extract|depth|length|type|valid|object|array|value)\s*\(|['\"](?:\s*(?:or|and)\s+['\"\d]|;)|\b(?:sqlite_master|pg_(?:catalog|sleep|user)|version|database)\s*\(|\bcopy\s+.*\s+(?:to|from)\s+program\b)" \
            "t:none,\
            t:base64Decode,\
            t:replaceComments,\
            t:htmlEntityDecode,\
            t:compressWhitespace,\
            t:lowercase"

# ----------------------------------------------------------------------------
# Rule 300006: Nested Base64 in ARGS (POST/JSON)
# ----------------------------------------------------------------------------

SecRule ARGS "@rx ^[A-Za-z0-9+/]{16,}={0,2}$" \
    "id:300006,\
    phase:2,\
    block,\
    nolog,\
    t:none,\
    capture,\
    msg:'SQL Injection with Nested Base64 Encoding Detected (Layer 2) - POST/JSON',\
    logdata:'Double-decoded payload: %{MATCHED_VAR}',\
    severity:CRITICAL,\
    tag:'attack-sqli',\
    tag:'attack-encoding-evasion',\
    tag:'paranoia-level/4',\
    tag:'OWASP_CRS/SQLI/NESTED',\
    setvar:'tx.sqli_potential_nested_b64=%{MATCHED_VAR}',\
    setvar:'tx.sql_injection_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}',\
    setvar:'tx.sqli_encoding_anomaly_score=+2',\
    chain"

    SecRule TX:sqli_potential_nested_b64 "@rx ^[A-Za-z0-9+/]{16,}={0,2}$" \
        "t:base64Decode,\
        setvar:'tx.sqli_nested_decoded_once=%{MATCHED_VAR}',\
        chain"

        SecRule TX:sqli_nested_decoded_once "@rx (?i)(?:\bunion\s+(?:all\s+)?select\b|;\s*(?:select|insert|update|delete|drop|alter|create|truncate|exec)\b|\b(?:sleep|benchmark|pg_sleep|waitfor\s+delay)\s*\(|\b(?:extractvalue|updatexml)\s*\(|floor\s*\(\s*rand\s*\(|\bexec(?:ute)?\s+(?:master|xp_|sp_)|xp_cmdshell|\b(?:information_schema|sys(?:databases|objects|columns|tables))\b|\b(?:load_file|into\s+(?:out|dump)file|load\s+data\s+infile)\b|\bor\s+[\d'\"]+\s*=\s*[\d'\"]+|/\*[!+].*?\*/|\bjson_(?:extract|depth|length|type|valid|object|array|value)\s*\(|['\"](?:\s*(?:or|and)\s+['\"\d]|;)|\b(?:sqlite_master|pg_(?:catalog|sleep|user)|version|database)\s*\(|\bcopy\s+.*\s+(?:to|from)\s+program\b)" \
            "t:none,\
            t:base64Decode,\
            t:replaceComments,\
            t:htmlEntityDecode,\
            t:compressWhitespace,\
            t:lowercase"

# ----------------------------------------------------------------------------
# Rule 300007: Nested Base64 in REQUEST_HEADERS
# ----------------------------------------------------------------------------

SecRule REQUEST_HEADERS "@rx ^[A-Za-z0-9+/]{16,}={0,2}$" \
    "id:300007,\
    phase:2,\
    block,\
    nolog,\
    t:none,\
    capture,\
    msg:'SQL Injection with Nested Base64 Encoding Detected (Layer 2) - Headers',\
    logdata:'Header: %{MATCHED_VAR_NAME}, Double-decoded: %{MATCHED_VAR}',\
    severity:CRITICAL,\
    tag:'attack-sqli',\
    tag:'attack-encoding-evasion',\
    tag:'paranoia-level/4',\
    tag:'OWASP_CRS/SQLI/NESTED',\
    setvar:'tx.sqli_potential_nested_b64=%{MATCHED_VAR}',\
    setvar:'tx.sql_injection_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}',\
    setvar:'tx.sqli_encoding_anomaly_score=+2',\
    chain"

    SecRule TX:sqli_potential_nested_b64 "@rx ^[A-Za-z0-9+/]{16,}={0,2}$" \
        "t:base64Decode,\
        setvar:'tx.sqli_nested_decoded_once=%{MATCHED_VAR}',\
        chain"

        SecRule TX:sqli_nested_decoded_once "@rx (?i)(?:\bunion\s+(?:all\s+)?select\b|;\s*(?:select|insert|update|delete|drop|alter|create|truncate|exec)\b|\b(?:sleep|benchmark|pg_sleep|waitfor\s+delay)\s*\(|\b(?:extractvalue|updatexml)\s*\(|floor\s*\(\s*rand\s*\(|\bexec(?:ute)?\s+(?:master|xp_|sp_)|xp_cmdshell|\b(?:information_schema|sys(?:databases|objects|columns|tables))\b|\b(?:load_file|into\s+(?:out|dump)file|load\s+data\s+infile)\b|\bor\s+[\d'\"]+\s*=\s*[\d'\"]+|/\*[!+].*?\*/|\bjson_(?:extract|depth|length|type|valid|object|array|value)\s*\(|['\"](?:\s*(?:or|and)\s+['\"\d]|;)|\b(?:sqlite_master|pg_(?:catalog|sleep|user)|version|database)\s*\(|\bcopy\s+.*\s+(?:to|from)\s+program\b)" \
            "t:none,\
            t:urlDecodeUni,\
            t:base64Decode,\
            t:replaceComments,\
            t:htmlEntityDecode,\
            t:compressWhitespace,\
            t:lowercase"

# ============================================================================
# LAYER 3: MIXED/POLYGLOT ENCODING DETECTION
# ============================================================================
# Handles: Base64(URL_Encode(SQLi)) or URL_Encode(Base64(SQLi))
# ============================================================================

# ----------------------------------------------------------------------------
# Rule 300008: Mixed Encoding in ARGS_GET (Base64 → URL order)
# ----------------------------------------------------------------------------

SecRule ARGS_GET "@rx ^[A-Za-z0-9+/%]{16,}={0,2}$" \
    "id:300008,\
    phase:2,\
    block,\
    nolog,\
    t:none,\
    msg:'SQL Injection with Mixed Encoding (Base64→URL) Detected (Layer 3) - URL Param',\
    logdata:'Mixed-decoded payload: %{MATCHED_VAR}',\
    severity:CRITICAL,\
    tag:'attack-sqli',\
    tag:'attack-polyglot-encoding',\
    tag:'paranoia-level/4',\
    tag:'OWASP_CRS/SQLI/MIXED',\
    setvar:'tx.sql_injection_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}',\
    setvar:'tx.sqli_encoding_anomaly_score=+3',\
    chain"

    SecRule MATCHED_VAR "@rx (?i)(?:\bunion\s+(?:all\s+)?select\b|;\s*(?:select|insert|update|delete|drop|alter|create|truncate|exec)\b|\b(?:sleep|benchmark|pg_sleep|waitfor\s+delay)\s*\(|\b(?:extractvalue|updatexml)\s*\(|floor\s*\(\s*rand\s*\(|\bexec(?:ute)?\s+(?:master|xp_|sp_)|xp_cmdshell|\b(?:information_schema|sys(?:databases|objects|columns|tables))\b|\b(?:load_file|into\s+(?:out|dump)file|load\s+data\s+infile)\b|\bor\s+[\d'\"]+\s*=\s*[\d'\"]+|/\*[!+].*?\*/|\bjson_(?:extract|depth|length|type|valid|object|array|value)\s*\(|['\"](?:\s*(?:or|and)\s+['\"\d]|;)|\b(?:sqlite_master|pg_(?:catalog|sleep|user)|version|database)\s*\(|\bcopy\s+.*\s+(?:to|from)\s+program\b)" \
        "t:none,\
        t:base64Decode,\
        t:urlDecodeUni,\
        t:replaceComments,\
        t:htmlEntityDecode,\
        t:compressWhitespace,\
        t:lowercase"

# ----------------------------------------------------------------------------
# Rule 300009: Mixed Encoding in ARGS_GET (URL → Base64 order)
# ----------------------------------------------------------------------------

SecRule ARGS_GET "@rx ^[A-Za-z0-9+/%]{16,}={0,2}$" \
    "id:300009,\
    phase:2,\
    block,\
    nolog,\
    t:none,\
    msg:'SQL Injection with Mixed Encoding (URL→Base64) Detected (Layer 3) - URL Param',\
    logdata:'Mixed-decoded payload: %{MATCHED_VAR}',\
    severity:CRITICAL,\
    tag:'attack-sqli',\
    tag:'attack-polyglot-encoding',\
    tag:'paranoia-level/4',\
    tag:'OWASP_CRS/SQLI/MIXED',\
    setvar:'tx.sql_injection_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}',\
    setvar:'tx.sqli_encoding_anomaly_score=+3',\
    chain"

    SecRule MATCHED_VAR "@rx (?i)(?:\bunion\s+(?:all\s+)?select\b|;\s*(?:select|insert|update|delete|drop|alter|create|truncate|exec)\b|\b(?:sleep|benchmark|pg_sleep|waitfor\s+delay)\s*\(|\b(?:extractvalue|updatexml)\s*\(|floor\s*\(\s*rand\s*\(|\bexec(?:ute)?\s+(?:master|xp_|sp_)|xp_cmdshell|\b(?:information_schema|sys(?:databases|objects|columns|tables))\b|\b(?:load_file|into\s+(?:out|dump)file|load\s+data\s+infile)\b|\bor\s+[\d'\"]+\s*=\s*[\d'\"]+|/\*[!+].*?\*/|\bjson_(?:extract|depth|length|type|valid|object|array|value)\s*\(|['\"](?:\s*(?:or|and)\s+['\"\d]|;)|\b(?:sqlite_master|pg_(?:catalog|sleep|user)|version|database)\s*\(|\bcopy\s+.*\s+(?:to|from)\s+program\b)" \
        "t:none,\
        t:urlDecodeUni,\
        t:base64Decode,\
        t:replaceComments,\
        t:htmlEntityDecode,\
        t:compressWhitespace,\
        t:lowercase"

# ----------------------------------------------------------------------------
# Rule 300010: Mixed Encoding in ARGS (POST/JSON) - Base64 → URL
# ----------------------------------------------------------------------------

SecRule ARGS "@rx ^[A-Za-z0-9+/%]{16,}={0,2}$" \
    "id:300010,\
    phase:2,\
    block,\
    nolog,\
    t:none,\
    msg:'SQL Injection with Mixed Encoding (Base64→URL) Detected (Layer 3) - POST/JSON',\
    logdata:'Mixed-decoded payload: %{MATCHED_VAR}',\
    severity:CRITICAL,\
    tag:'attack-sqli',\
    tag:'attack-polyglot-encoding',\
    tag:'paranoia-level/4',\
    tag:'OWASP_CRS/SQLI/MIXED',\
    setvar:'tx.sql_injection_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}',\
    setvar:'tx.sqli_encoding_anomaly_score=+3',\
    chain"

    SecRule MATCHED_VAR "@rx (?i)(?:\bunion\s+(?:all\s+)?select\b|;\s*(?:select|insert|update|delete|drop|alter|create|truncate|exec)\b|\b(?:sleep|benchmark|pg_sleep|waitfor\s+delay)\s*\(|\b(?:extractvalue|updatexml)\s*\(|floor\s*\(\s*rand\s*\(|\bexec(?:ute)?\s+(?:master|xp_|sp_)|xp_cmdshell|\b(?:information_schema|sys(?:databases|objects|columns|tables))\b|\b(?:load_file|into\s+(?:out|dump)file|load\s+data\s+infile)\b|\bor\s+[\d'\"]+\s*=\s*[\d'\"]+|/\*[!+].*?\*/|\bjson_(?:extract|depth|length|type|valid|object|array|value)\s*\(|['\"](?:\s*(?:or|and)\s+['\"\d]|;)|\b(?:sqlite_master|pg_(?:catalog|sleep|user)|version|database)\s*\(|\bcopy\s+.*\s+(?:to|from)\s+program\b)" \
        "t:none,\
        t:base64Decode,\
        t:urlDecodeUni,\
        t:replaceComments,\
        t:htmlEntityDecode,\
        t:compressWhitespace,\
        t:lowercase"

# ----------------------------------------------------------------------------
# Rule 300011: Mixed Encoding in ARGS (POST/JSON) - URL → Base64
# ----------------------------------------------------------------------------

SecRule ARGS "@rx ^[A-Za-z0-9+/%]{16,}={0,2}$" \
    "id:300011,\
    phase:2,\
    block,\
    nolog,\
    t:none,\
    msg:'SQL Injection with Mixed Encoding (URL→Base64) Detected (Layer 3) - POST/JSON',\
    logdata:'Mixed-decoded payload: %{MATCHED_VAR}',\
    severity:CRITICAL,\
    tag:'attack-sqli',\
    tag:'attack-polyglot-encoding',\
    tag:'paranoia-level/4',\
    tag:'OWASP_CRS/SQLI/MIXED',\
    setvar:'tx.sql_injection_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}',\
    setvar:'tx.sqli_encoding_anomaly_score=+3',\
    chain"

    SecRule MATCHED_VAR "@rx (?i)(?:\bunion\s+(?:all\s+)?select\b|;\s*(?:select|insert|update|delete|drop|alter|create|truncate|exec)\b|\b(?:sleep|benchmark|pg_sleep|waitfor\s+delay)\s*\(|\b(?:extractvalue|updatexml)\s*\(|floor\s*\(\s*rand\s*\(|\bexec(?:ute)?\s+(?:master|xp_|sp_)|xp_cmdshell|\b(?:information_schema|sys(?:databases|objects|columns|tables))\b|\b(?:load_file|into\s+(?:out|dump)file|load\s+data\s+infile)\b|\bor\s+[\d'\"]+\s*=\s*[\d'\"]+|/\*[!+].*?\*/|\bjson_(?:extract|depth|length|type|valid|object|array|value)\s*\(|['\"](?:\s*(?:or|and)\s+['\"\d]|;)|\b(?:sqlite_master|pg_(?:catalog|sleep|user)|version|database)\s*\(|\bcopy\s+.*\s+(?:to|from)\s+program\b)" \
        "t:none,\
        t:urlDecodeUni,\
        t:base64Decode,\
        t:replaceComments,\
        t:htmlEntityDecode,\
        t:compressWhitespace,\
        t:lowercase"

# ----------------------------------------------------------------------------
# Rule 300012: Mixed Encoding in REQUEST_HEADERS - Base64 → URL
# ----------------------------------------------------------------------------

SecRule REQUEST_HEADERS "@rx ^[A-Za-z0-9+/%]{16,}={0,2}$" \
    "id:300012,\
    phase:2,\
    block,\
    nolog,\
    t:none,\
    msg:'SQL Injection with Mixed Encoding (Base64→URL) Detected (Layer 3) - Headers',\
    logdata:'Header: %{MATCHED_VAR_NAME}, Mixed-decoded: %{MATCHED_VAR}',\
    severity:CRITICAL,\
    tag:'attack-sqli',\
    tag:'attack-polyglot-encoding',\
    tag:'paranoia-level/4',\
    tag:'OWASP_CRS/SQLI/MIXED',\
    setvar:'tx.sql_injection_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}',\
    setvar:'tx.sqli_encoding_anomaly_score=+3',\
    chain"

    SecRule MATCHED_VAR "@rx (?i)(?:\bunion\s+(?:all\s+)?select\b|;\s*(?:select|insert|update|delete|drop|alter|create|truncate|exec)\b|\b(?:sleep|benchmark|pg_sleep|waitfor\s+delay)\s*\(|\b(?:extractvalue|updatexml)\s*\(|floor\s*\(\s*rand\s*\(|\bexec(?:ute)?\s+(?:master|xp_|sp_)|xp_cmdshell|\b(?:information_schema|sys(?:databases|objects|columns|tables))\b|\b(?:load_file|into\s+(?:out|dump)file|load\s+data\s+infile)\b|\bor\s+[\d'\"]+\s*=\s*[\d'\"]+|/\*[!+].*?\*/|\bjson_(?:extract|depth|length|type|valid|object|array|value)\s*\(|['\"](?:\s*(?:or|and)\s+['\"\d]|;)|\b(?:sqlite_master|pg_(?:catalog|sleep|user)|version|database)\s*\(|\bcopy\s+.*\s+(?:to|from)\s+program\b)" \
        "t:none,\
        t:base64Decode,\
        t:urlDecodeUni,\
        t:replaceComments,\
        t:htmlEntityDecode,\
        t:compressWhitespace,\
        t:lowercase"

# ----------------------------------------------------------------------------
# Rule 300013: Mixed Encoding in REQUEST_HEADERS - URL → Base64
# ----------------------------------------------------------------------------

SecRule REQUEST_HEADERS "@rx ^[A-Za-z0-9+/%]{16,}={0,2}$" \
    "id:300013,\
    phase:2,\
    block,\
    nolog,\
    t:none,\
    msg:'SQL Injection with Mixed Encoding (URL→Base64) Detected (Layer 3) - Headers',\
    logdata:'Header: %{MATCHED_VAR_NAME}, Mixed-decoded: %{MATCHED_VAR}',\
    severity:CRITICAL,\
    tag:'attack-sqli',\
    tag:'attack-polyglot-encoding',\
    tag:'paranoia-level/4',\
    tag:'OWASP_CRS/SQLI/MIXED',\
    setvar:'tx.sql_injection_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}',\
    setvar:'tx.sqli_encoding_anomaly_score=+3',\
    chain"

    SecRule MATCHED_VAR "@rx (?i)(?:\bunion\s+(?:all\s+)?select\b|;\s*(?:select|insert|update|delete|drop|alter|create|truncate|exec)\b|\b(?:sleep|benchmark|pg_sleep|waitfor\s+delay)\s*\(|\b(?:extractvalue|updatexml)\s*\(|floor\s*\(\s*rand\s*\(|\bexec(?:ute)?\s+(?:master|xp_|sp_)|xp_cmdshell|\b(?:information_schema|sys(?:databases|objects|columns|tables))\b|\b(?:load_file|into\s+(?:out|dump)file|load\s+data\s+infile)\b|\bor\s+[\d'\"]+\s*=\s*[\d'\"]+|/\*[!+].*?\*/|\bjson_(?:extract|depth|length|type|valid|object|array|value)\s*\(|['\"](?:\s*(?:or|and)\s+['\"\d]|;)|\b(?:sqlite_master|pg_(?:catalog|sleep|user)|version|database)\s*\(|\bcopy\s+.*\s+(?:to|from)\s+program\b)" \
        "t:none,\
        t:urlDecodeUni,\
        t:base64Decode,\
        t:replaceComments,\
        t:htmlEntityDecode,\
        t:compressWhitespace,\
        t:lowercase"

# ============================================================================
# LAYER 4: ANOMALY DETECTION - Suspicious Encoding Patterns
# ============================================================================

# ----------------------------------------------------------------------------
# Rule 300014: Flag Suspicious Nested Encoding
# ----------------------------------------------------------------------------

SecRule ARGS|ARGS_GET|REQUEST_HEADERS "@rx ^(?:[A-Za-z0-9+/]{16,}={0,2})$" \
    "id:300014,\
    phase:2,\
    pass,\
    t:none,\
    t:base64Decode,\
    msg:'Suspicious Nested Encoding Detected (SQLi Anomaly)',\
    logdata:'Potential encoding evasion attempt: %{MATCHED_VAR_NAME}',\
    severity:WARNING,\
    tag:'anomaly-detection',\
    tag:'encoding-evasion',\
    tag:'paranoia-level/4',\
    setvar:'tx.sqli_encoding_anomaly_score=+2',\
    setvar:'tx.inbound_anomaly_score_pl4=+2',\
    chain"

    SecRule MATCHED_VAR "@rx ^(?:[A-Za-z0-9+/]{16,}={0,2})$" \
        "t:none"

# ============================================================================
# END OF GENERALIZED SQL INJECTION RULES
# ============================================================================
