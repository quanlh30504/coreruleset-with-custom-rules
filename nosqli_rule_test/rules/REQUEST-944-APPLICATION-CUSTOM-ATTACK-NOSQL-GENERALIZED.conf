# ============================================================================
# OWASP CRS - Generalized NoSQL Injection Detection Rules
# Rule ID Range: 400000-400014
# ============================================================================
# Purpose: Structure-based NoSQL injection detection with multi-database
#          coverage (MongoDB, Redis, CouchDB) and nested encoding support
#
# Key Improvements over ID 100130-100146 (research team):
# 1. 8 pattern categories vs 9 vague patterns
# 2. 16+ MongoDB operators vs 2 ($where, $or)
# 3. Redis + CouchDB coverage (new)
# 4. Auth bypass detection (new)
# 5. JS injection with structure-based matching
# 6. Triple-layer decoding (standard, nested Base64, mixed encoding)
# 7. Correct log messages and score variables
# 8. Reduced false positives (no more matching ";" or "true")
#
# ============================================================================

# ----------------------------------------------------------------------------
# LAYER 0: CONFIGURATION VARIABLES
# ----------------------------------------------------------------------------

SecAction \
    "id:400000,\
    phase:1,\
    nolog,\
    pass,\
    t:none,\
    setvar:'tx.nosqli_nested_decoding=1',\
    setvar:'tx.nosqli_max_decode_depth=2',\
    setvar:'tx.nosqli_encoding_anomaly_score=3'"

# ============================================================================
# LAYER 1: STANDARD DECODING + CORE NoSQLi DETECTION
# ============================================================================
# 8 pattern categories covering MongoDB, Redis, CouchDB
# ============================================================================

# ----------------------------------------------------------------------------
# Rule 400001: NoSQLi Detection in REQUEST_URI (URL Path)
# ----------------------------------------------------------------------------

SecRule REQUEST_URI "@rx ^.*/([^/]+)$" \
    "id:400001,\
    phase:2,\
    block,\
    capture,\
    t:none,\
    setvar:'tx.nosqli_urlpath_payload=%{TX.1}',\
    msg:'NoSQL Injection Attack Detected in URL Path (Layer 1)',\
    logdata:'Payload: %{TX.1}',\
    severity:CRITICAL,\
    tag:'attack-nosqli',\
    tag:'paranoia-level/4',\
    tag:'OWASP_CRS/NOSQLI/GENERALIZED',\
    setvar:'tx.nosql_injection_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}',\
    chain"

    SecRule TX:nosqli_urlpath_payload "@rx (?i)(?:\$(?:where|n(?:e|in|ot|or)|eq|g(?:t|te)|l(?:t|te)|in|exists|regex|type|mod|size|all|elemMatch|set|unset|push|pull|addToSet|inc|rename|group|project|lookup|match|sort)\b|\$(?:or|and|nor)\s*[\[\{:]|(?:function\s*\(|this\.\w+\s*[=!<>]|\beval\s*\(|process\.(?:exit|env|mainModule)|require\s*\(\s*['\"](?:child_process|fs|net|http))|(?:db|collection)\s*\.\s*\w+\s*\.\s*(?:find|insert|update|remove|drop|aggregate|count|distinct)\s*\(|\{\s*['\"]?\$(?:ne|gt|gte|lt|lte|nin)['\"]?\s*:\s*(?:['\"]|null|\[\]|\d)|\[\s*\$(?:ne|gt)\s*\]|\$(?:ne|gt)\s*[:=]\s*(?:['\"]|null|\d)|(?:ObjectId|ISODate|NumberLong|NumberInt|BinData)\s*\(|(?:mapReduce|forEach|toArray)\s*\(|\b(?:EVAL|EVALSHA)\s+['\"]|\b(?:CONFIG|FLUSHALL|FLUSHDB|DEBUG|SHUTDOWN|SLAVEOF|REPLICAOF|MODULE)\b|\b(?:SET|GET|DEL|KEYS|HSET|HGET|SADD|ZADD|LPUSH|RPUSH)\s+\S+\s|(?:_all_docs|_design/|_view/|_find|_changes)\b|emit\s*\(\s*|(?:selector|fields)\s*['\"]?\s*:\s*\{.*\$(?:gt|lt|eq|ne|regex))" \
        "t:none,\
        t:urlDecodeUni,\
        t:base64Decode,\
        t:htmlEntityDecode,\
        t:compressWhitespace,\
        t:lowercase"

# ----------------------------------------------------------------------------
# Rule 400002: NoSQLi Detection in ARGS_GET (URL Parameters)
# ----------------------------------------------------------------------------

SecRule ARGS_GET "@rx (?i)(?:\$(?:where|n(?:e|in|ot|or)|eq|g(?:t|te)|l(?:t|te)|in|exists|regex|type|mod|size|all|elemMatch|set|unset|push|pull|addToSet|inc|rename|group|project|lookup|match|sort)\b|\$(?:or|and|nor)\s*[\[\{:]|(?:function\s*\(|this\.\w+\s*[=!<>]|\beval\s*\(|process\.(?:exit|env|mainModule)|require\s*\(\s*['\"](?:child_process|fs|net|http))|(?:db|collection)\s*\.\s*\w+\s*\.\s*(?:find|insert|update|remove|drop|aggregate|count|distinct)\s*\(|\{\s*['\"]?\$(?:ne|gt|gte|lt|lte|nin)['\"]?\s*:\s*(?:['\"]|null|\[\]|\d)|\[\s*\$(?:ne|gt)\s*\]|\$(?:ne|gt)\s*[:=]\s*(?:['\"]|null|\d)|(?:ObjectId|ISODate|NumberLong|NumberInt|BinData)\s*\(|(?:mapReduce|forEach|toArray)\s*\(|\b(?:EVAL|EVALSHA)\s+['\"]|\b(?:CONFIG|FLUSHALL|FLUSHDB|DEBUG|SHUTDOWN|SLAVEOF|REPLICAOF|MODULE)\b|\b(?:SET|GET|DEL|KEYS|HSET|HGET|SADD|ZADD|LPUSH|RPUSH)\s+\S+\s|(?:_all_docs|_design/|_view/|_find|_changes)\b|emit\s*\(\s*|(?:selector|fields)\s*['\"]?\s*:\s*\{.*\$(?:gt|lt|eq|ne|regex))" \
    "id:400002,\
    phase:2,\
    t:none,\
    t:base64Decode,\
    t:htmlEntityDecode,\
    t:compressWhitespace,\
    t:lowercase,\
    block,\
    msg:'NoSQL Injection Attack Detected in URL Parameters (Layer 1)',\
    logdata:'Parameter: %{MATCHED_VAR_NAME}, Payload: %{MATCHED_VAR}',\
    severity:CRITICAL,\
    tag:'attack-nosqli',\
    tag:'paranoia-level/4',\
    tag:'OWASP_CRS/NOSQLI/GENERALIZED',\
    setvar:'tx.nosql_injection_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}'"

# ----------------------------------------------------------------------------
# Rule 400003: NoSQLi Detection in ARGS (POST Body / JSON)
# ----------------------------------------------------------------------------
# This is the PRIMARY vector for NoSQL injection because MongoDB
# queries are often sent as JSON in POST body

SecRule ARGS "@rx (?i)(?:\$(?:where|n(?:e|in|ot|or)|eq|g(?:t|te)|l(?:t|te)|in|exists|regex|type|mod|size|all|elemMatch|set|unset|push|pull|addToSet|inc|rename|group|project|lookup|match|sort)\b|\$(?:or|and|nor)\s*[\[\{:]|(?:function\s*\(|this\.\w+\s*[=!<>]|\beval\s*\(|process\.(?:exit|env|mainModule)|require\s*\(\s*['\"](?:child_process|fs|net|http))|(?:db|collection)\s*\.\s*\w+\s*\.\s*(?:find|insert|update|remove|drop|aggregate|count|distinct)\s*\(|\{\s*['\"]?\$(?:ne|gt|gte|lt|lte|nin)['\"]?\s*:\s*(?:['\"]|null|\[\]|\d)|\[\s*\$(?:ne|gt)\s*\]|\$(?:ne|gt)\s*[:=]\s*(?:['\"]|null|\d)|(?:ObjectId|ISODate|NumberLong|NumberInt|BinData)\s*\(|(?:mapReduce|forEach|toArray)\s*\(|\b(?:EVAL|EVALSHA)\s+['\"]|\b(?:CONFIG|FLUSHALL|FLUSHDB|DEBUG|SHUTDOWN|SLAVEOF|REPLICAOF|MODULE)\b|\b(?:SET|GET|DEL|KEYS|HSET|HGET|SADD|ZADD|LPUSH|RPUSH)\s+\S+\s|(?:_all_docs|_design/|_view/|_find|_changes)\b|emit\s*\(\s*|(?:selector|fields)\s*['\"]?\s*:\s*\{.*\$(?:gt|lt|eq|ne|regex))" \
    "id:400003,\
    phase:2,\
    t:none,\
    t:base64Decode,\
    t:htmlEntityDecode,\
    t:compressWhitespace,\
    t:lowercase,\
    block,\
    msg:'NoSQL Injection Attack Detected in POST/JSON Data (Layer 1)',\
    logdata:'Parameter: %{MATCHED_VAR_NAME}, Payload: %{MATCHED_VAR}',\
    severity:CRITICAL,\
    tag:'attack-nosqli',\
    tag:'paranoia-level/4',\
    tag:'OWASP_CRS/NOSQLI/GENERALIZED',\
    setvar:'tx.nosql_injection_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}'"

# ----------------------------------------------------------------------------
# Rule 400004: NoSQLi Detection in REQUEST_HEADERS
# ----------------------------------------------------------------------------

SecRule REQUEST_HEADERS "@rx (?i)(?:\$(?:where|n(?:e|in|ot|or)|eq|g(?:t|te)|l(?:t|te)|in|exists|regex|type|mod|size|all|elemMatch|set|unset|push|pull|addToSet|inc|rename|group|project|lookup|match|sort)\b|\$(?:or|and|nor)\s*[\[\{:]|(?:function\s*\(|this\.\w+\s*[=!<>]|\beval\s*\(|process\.(?:exit|env|mainModule)|require\s*\(\s*['\"](?:child_process|fs|net|http))|(?:db|collection)\s*\.\s*\w+\s*\.\s*(?:find|insert|update|remove|drop|aggregate|count|distinct)\s*\(|\{\s*['\"]?\$(?:ne|gt|gte|lt|lte|nin)['\"]?\s*:\s*(?:['\"]|null|\[\]|\d)|\[\s*\$(?:ne|gt)\s*\]|\$(?:ne|gt)\s*[:=]\s*(?:['\"]|null|\d)|(?:ObjectId|ISODate|NumberLong|NumberInt|BinData)\s*\(|(?:mapReduce|forEach|toArray)\s*\(|\b(?:EVAL|EVALSHA)\s+['\"]|\b(?:CONFIG|FLUSHALL|FLUSHDB|DEBUG|SHUTDOWN|SLAVEOF|REPLICAOF|MODULE)\b|\b(?:SET|GET|DEL|KEYS|HSET|HGET|SADD|ZADD|LPUSH|RPUSH)\s+\S+\s|(?:_all_docs|_design/|_view/|_find|_changes)\b|emit\s*\(\s*|(?:selector|fields)\s*['\"]?\s*:\s*\{.*\$(?:gt|lt|eq|ne|regex))" \
    "id:400004,\
    phase:2,\
    t:none,\
    t:urlDecodeUni,\
    t:base64Decode,\
    t:htmlEntityDecode,\
    t:compressWhitespace,\
    t:lowercase,\
    block,\
    msg:'NoSQL Injection Attack Detected in HTTP Headers (Layer 1)',\
    logdata:'Header: %{MATCHED_VAR_NAME}, Payload: %{MATCHED_VAR}',\
    severity:CRITICAL,\
    tag:'attack-nosqli',\
    tag:'paranoia-level/4',\
    tag:'OWASP_CRS/NOSQLI/GENERALIZED',\
    setvar:'tx.nosql_injection_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}'"

# ============================================================================
# LAYER 2: NESTED BASE64 DETECTION
# ============================================================================

# ----------------------------------------------------------------------------
# Rule 400005: Nested Base64 in ARGS_GET
# ----------------------------------------------------------------------------

SecRule ARGS_GET "@rx ^[A-Za-z0-9+/]{16,}={0,2}$" \
    "id:400005,\
    phase:2,\
    block,\
    nolog,\
    t:none,\
    capture,\
    msg:'NoSQL Injection with Nested Base64 Detected (Layer 2) - URL Param',\
    logdata:'Double-decoded payload: %{MATCHED_VAR}',\
    severity:CRITICAL,\
    tag:'attack-nosqli',\
    tag:'attack-encoding-evasion',\
    tag:'paranoia-level/4',\
    tag:'OWASP_CRS/NOSQLI/NESTED',\
    setvar:'tx.nosqli_potential_nested_b64=%{MATCHED_VAR}',\
    setvar:'tx.nosql_injection_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}',\
    setvar:'tx.nosqli_encoding_anomaly_score=+2',\
    chain"

    SecRule TX:nosqli_potential_nested_b64 "@rx ^[A-Za-z0-9+/]{16,}={0,2}$" \
        "t:base64Decode,\
        setvar:'tx.nosqli_nested_decoded=%{MATCHED_VAR}',\
        chain"

        SecRule TX:nosqli_nested_decoded "@rx (?i)(?:\$(?:where|n(?:e|in|ot|or)|eq|g(?:t|te)|l(?:t|te)|in|exists|regex|type|mod|size|all|elemMatch|set|unset|push|pull|addToSet|inc|rename|group|project|lookup|match|sort)\b|\$(?:or|and|nor)\s*[\[\{:]|(?:function\s*\(|this\.\w+\s*[=!<>]|\beval\s*\(|process\.(?:exit|env|mainModule)|require\s*\(\s*['\"](?:child_process|fs|net|http))|(?:db|collection)\s*\.\s*\w+\s*\.\s*(?:find|insert|update|remove|drop|aggregate|count|distinct)\s*\(|\{\s*['\"]?\$(?:ne|gt|gte|lt|lte|nin)['\"]?\s*:\s*(?:['\"]|null|\[\]|\d)|\b(?:EVAL|EVALSHA)\s+['\"]|\b(?:CONFIG|FLUSHALL|FLUSHDB|DEBUG|SHUTDOWN|SLAVEOF|REPLICAOF|MODULE)\b|(?:_all_docs|_design/|_view/|_find|_changes)\b)" \
            "t:none,\
            t:base64Decode,\
            t:htmlEntityDecode,\
            t:compressWhitespace,\
            t:lowercase"

# ----------------------------------------------------------------------------
# Rule 400006: Nested Base64 in ARGS (POST/JSON)
# ----------------------------------------------------------------------------

SecRule ARGS "@rx ^[A-Za-z0-9+/]{16,}={0,2}$" \
    "id:400006,\
    phase:2,\
    block,\
    nolog,\
    t:none,\
    capture,\
    msg:'NoSQL Injection with Nested Base64 Detected (Layer 2) - POST/JSON',\
    logdata:'Double-decoded payload: %{MATCHED_VAR}',\
    severity:CRITICAL,\
    tag:'attack-nosqli',\
    tag:'attack-encoding-evasion',\
    tag:'paranoia-level/4',\
    tag:'OWASP_CRS/NOSQLI/NESTED',\
    setvar:'tx.nosqli_potential_nested_b64=%{MATCHED_VAR}',\
    setvar:'tx.nosql_injection_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}',\
    setvar:'tx.nosqli_encoding_anomaly_score=+2',\
    chain"

    SecRule TX:nosqli_potential_nested_b64 "@rx ^[A-Za-z0-9+/]{16,}={0,2}$" \
        "t:base64Decode,\
        setvar:'tx.nosqli_nested_decoded=%{MATCHED_VAR}',\
        chain"

        SecRule TX:nosqli_nested_decoded "@rx (?i)(?:\$(?:where|n(?:e|in|ot|or)|eq|g(?:t|te)|l(?:t|te)|in|exists|regex|type|mod|size|all|elemMatch|set|unset|push|pull|addToSet|inc|rename|group|project|lookup|match|sort)\b|\$(?:or|and|nor)\s*[\[\{:]|(?:function\s*\(|this\.\w+\s*[=!<>]|\beval\s*\(|process\.(?:exit|env|mainModule)|require\s*\(\s*['\"](?:child_process|fs|net|http))|(?:db|collection)\s*\.\s*\w+\s*\.\s*(?:find|insert|update|remove|drop|aggregate|count|distinct)\s*\(|\{\s*['\"]?\$(?:ne|gt|gte|lt|lte|nin)['\"]?\s*:\s*(?:['\"]|null|\[\]|\d)|\b(?:EVAL|EVALSHA)\s+['\"]|\b(?:CONFIG|FLUSHALL|FLUSHDB|DEBUG|SHUTDOWN|SLAVEOF|REPLICAOF|MODULE)\b|(?:_all_docs|_design/|_view/|_find|_changes)\b)" \
            "t:none,\
            t:base64Decode,\
            t:htmlEntityDecode,\
            t:compressWhitespace,\
            t:lowercase"

# ----------------------------------------------------------------------------
# Rule 400007: Nested Base64 in REQUEST_HEADERS
# ----------------------------------------------------------------------------

SecRule REQUEST_HEADERS "@rx ^[A-Za-z0-9+/]{16,}={0,2}$" \
    "id:400007,\
    phase:2,\
    block,\
    nolog,\
    t:none,\
    capture,\
    msg:'NoSQL Injection with Nested Base64 Detected (Layer 2) - Headers',\
    logdata:'Header: %{MATCHED_VAR_NAME}, Double-decoded: %{MATCHED_VAR}',\
    severity:CRITICAL,\
    tag:'attack-nosqli',\
    tag:'attack-encoding-evasion',\
    tag:'paranoia-level/4',\
    tag:'OWASP_CRS/NOSQLI/NESTED',\
    setvar:'tx.nosqli_potential_nested_b64=%{MATCHED_VAR}',\
    setvar:'tx.nosql_injection_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}',\
    setvar:'tx.nosqli_encoding_anomaly_score=+2',\
    chain"

    SecRule TX:nosqli_potential_nested_b64 "@rx ^[A-Za-z0-9+/]{16,}={0,2}$" \
        "t:base64Decode,\
        setvar:'tx.nosqli_nested_decoded=%{MATCHED_VAR}',\
        chain"

        SecRule TX:nosqli_nested_decoded "@rx (?i)(?:\$(?:where|n(?:e|in|ot|or)|eq|g(?:t|te)|l(?:t|te)|in|exists|regex|type|mod|size|all|elemMatch|set|unset|push|pull|addToSet|inc|rename|group|project|lookup|match|sort)\b|\$(?:or|and|nor)\s*[\[\{:]|(?:function\s*\(|this\.\w+\s*[=!<>]|\beval\s*\(|process\.(?:exit|env|mainModule)|require\s*\(\s*['\"](?:child_process|fs|net|http))|(?:db|collection)\s*\.\s*\w+\s*\.\s*(?:find|insert|update|remove|drop|aggregate|count|distinct)\s*\(|\{\s*['\"]?\$(?:ne|gt|gte|lt|lte|nin)['\"]?\s*:\s*(?:['\"]|null|\[\]|\d)|\b(?:EVAL|EVALSHA)\s+['\"]|\b(?:CONFIG|FLUSHALL|FLUSHDB|DEBUG|SHUTDOWN|SLAVEOF|REPLICAOF|MODULE)\b|(?:_all_docs|_design/|_view/|_find|_changes)\b)" \
            "t:none,\
            t:urlDecodeUni,\
            t:base64Decode,\
            t:htmlEntityDecode,\
            t:compressWhitespace,\
            t:lowercase"

# ============================================================================
# LAYER 3: MIXED/POLYGLOT ENCODING DETECTION
# ============================================================================

# ----------------------------------------------------------------------------
# Rule 400008: Mixed Encoding in ARGS_GET (Base64 → URL)
# ----------------------------------------------------------------------------

SecRule ARGS_GET "@rx ^[A-Za-z0-9+/%]{16,}={0,2}$" \
    "id:400008,\
    phase:2,\
    block,\
    nolog,\
    t:none,\
    msg:'NoSQL Injection with Mixed Encoding (Base64→URL) (Layer 3) - URL Param',\
    logdata:'Mixed-decoded payload: %{MATCHED_VAR}',\
    severity:CRITICAL,\
    tag:'attack-nosqli',\
    tag:'attack-polyglot-encoding',\
    tag:'paranoia-level/4',\
    tag:'OWASP_CRS/NOSQLI/MIXED',\
    setvar:'tx.nosql_injection_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}',\
    setvar:'tx.nosqli_encoding_anomaly_score=+3',\
    chain"

    SecRule MATCHED_VAR "@rx (?i)(?:\$(?:where|n(?:e|in|ot|or)|eq|g(?:t|te)|l(?:t|te)|in|exists|regex|type|mod|size|all|elemMatch|set|unset|push|pull|addToSet|inc|rename|group|project|lookup|match|sort)\b|\$(?:or|and|nor)\s*[\[\{:]|(?:function\s*\(|this\.\w+\s*[=!<>]|\beval\s*\(|process\.(?:exit|env|mainModule))|(?:db|collection)\s*\.\s*\w+\s*\.\s*(?:find|insert|update|remove|drop|aggregate)\s*\(|\{\s*['\"]?\$(?:ne|gt|gte|lt|lte|nin)['\"]?\s*:\s*(?:['\"]|null|\[\]|\d)|\b(?:EVAL|EVALSHA)\s+['\"]|\b(?:CONFIG|FLUSHALL|FLUSHDB|DEBUG|SHUTDOWN)\b|(?:_all_docs|_design/|_view/|_find)\b)" \
        "t:none,\
        t:base64Decode,\
        t:urlDecodeUni,\
        t:htmlEntityDecode,\
        t:compressWhitespace,\
        t:lowercase"

# ----------------------------------------------------------------------------
# Rule 400009: Mixed Encoding in ARGS_GET (URL → Base64)
# ----------------------------------------------------------------------------

SecRule ARGS_GET "@rx ^[A-Za-z0-9+/%]{16,}={0,2}$" \
    "id:400009,\
    phase:2,\
    block,\
    nolog,\
    t:none,\
    msg:'NoSQL Injection with Mixed Encoding (URL→Base64) (Layer 3) - URL Param',\
    logdata:'Mixed-decoded payload: %{MATCHED_VAR}',\
    severity:CRITICAL,\
    tag:'attack-nosqli',\
    tag:'attack-polyglot-encoding',\
    tag:'paranoia-level/4',\
    tag:'OWASP_CRS/NOSQLI/MIXED',\
    setvar:'tx.nosql_injection_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}',\
    setvar:'tx.nosqli_encoding_anomaly_score=+3',\
    chain"

    SecRule MATCHED_VAR "@rx (?i)(?:\$(?:where|n(?:e|in|ot|or)|eq|g(?:t|te)|l(?:t|te)|in|exists|regex|type|mod|size|all|elemMatch|set|unset|push|pull|addToSet|inc|rename|group|project|lookup|match|sort)\b|\$(?:or|and|nor)\s*[\[\{:]|(?:function\s*\(|this\.\w+\s*[=!<>]|\beval\s*\(|process\.(?:exit|env|mainModule))|(?:db|collection)\s*\.\s*\w+\s*\.\s*(?:find|insert|update|remove|drop|aggregate)\s*\(|\{\s*['\"]?\$(?:ne|gt|gte|lt|lte|nin)['\"]?\s*:\s*(?:['\"]|null|\[\]|\d)|\b(?:EVAL|EVALSHA)\s+['\"]|\b(?:CONFIG|FLUSHALL|FLUSHDB|DEBUG|SHUTDOWN)\b|(?:_all_docs|_design/|_view/|_find)\b)" \
        "t:none,\
        t:urlDecodeUni,\
        t:base64Decode,\
        t:htmlEntityDecode,\
        t:compressWhitespace,\
        t:lowercase"

# ----------------------------------------------------------------------------
# Rule 400010: Mixed Encoding in ARGS (POST/JSON) - Base64 → URL
# ----------------------------------------------------------------------------

SecRule ARGS "@rx ^[A-Za-z0-9+/%]{16,}={0,2}$" \
    "id:400010,\
    phase:2,\
    block,\
    nolog,\
    t:none,\
    msg:'NoSQL Injection with Mixed Encoding (Base64→URL) (Layer 3) - POST/JSON',\
    logdata:'Mixed-decoded payload: %{MATCHED_VAR}',\
    severity:CRITICAL,\
    tag:'attack-nosqli',\
    tag:'attack-polyglot-encoding',\
    tag:'paranoia-level/4',\
    tag:'OWASP_CRS/NOSQLI/MIXED',\
    setvar:'tx.nosql_injection_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}',\
    setvar:'tx.nosqli_encoding_anomaly_score=+3',\
    chain"

    SecRule MATCHED_VAR "@rx (?i)(?:\$(?:where|n(?:e|in|ot|or)|eq|g(?:t|te)|l(?:t|te)|in|exists|regex|type|mod|size|all|elemMatch|set|unset|push|pull|addToSet|inc|rename|group|project|lookup|match|sort)\b|\$(?:or|and|nor)\s*[\[\{:]|(?:function\s*\(|this\.\w+\s*[=!<>]|\beval\s*\(|process\.(?:exit|env|mainModule))|(?:db|collection)\s*\.\s*\w+\s*\.\s*(?:find|insert|update|remove|drop|aggregate)\s*\(|\{\s*['\"]?\$(?:ne|gt|gte|lt|lte|nin)['\"]?\s*:\s*(?:['\"]|null|\[\]|\d)|\b(?:EVAL|EVALSHA)\s+['\"]|\b(?:CONFIG|FLUSHALL|FLUSHDB|DEBUG|SHUTDOWN)\b|(?:_all_docs|_design/|_view/|_find)\b)" \
        "t:none,\
        t:base64Decode,\
        t:urlDecodeUni,\
        t:htmlEntityDecode,\
        t:compressWhitespace,\
        t:lowercase"

# ----------------------------------------------------------------------------
# Rule 400011: Mixed Encoding in ARGS (POST/JSON) - URL → Base64
# ----------------------------------------------------------------------------

SecRule ARGS "@rx ^[A-Za-z0-9+/%]{16,}={0,2}$" \
    "id:400011,\
    phase:2,\
    block,\
    nolog,\
    t:none,\
    msg:'NoSQL Injection with Mixed Encoding (URL→Base64) (Layer 3) - POST/JSON',\
    logdata:'Mixed-decoded payload: %{MATCHED_VAR}',\
    severity:CRITICAL,\
    tag:'attack-nosqli',\
    tag:'attack-polyglot-encoding',\
    tag:'paranoia-level/4',\
    tag:'OWASP_CRS/NOSQLI/MIXED',\
    setvar:'tx.nosql_injection_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}',\
    setvar:'tx.nosqli_encoding_anomaly_score=+3',\
    chain"

    SecRule MATCHED_VAR "@rx (?i)(?:\$(?:where|n(?:e|in|ot|or)|eq|g(?:t|te)|l(?:t|te)|in|exists|regex|type|mod|size|all|elemMatch|set|unset|push|pull|addToSet|inc|rename|group|project|lookup|match|sort)\b|\$(?:or|and|nor)\s*[\[\{:]|(?:function\s*\(|this\.\w+\s*[=!<>]|\beval\s*\(|process\.(?:exit|env|mainModule))|(?:db|collection)\s*\.\s*\w+\s*\.\s*(?:find|insert|update|remove|drop|aggregate)\s*\(|\{\s*['\"]?\$(?:ne|gt|gte|lt|lte|nin)['\"]?\s*:\s*(?:['\"]|null|\[\]|\d)|\b(?:EVAL|EVALSHA)\s+['\"]|\b(?:CONFIG|FLUSHALL|FLUSHDB|DEBUG|SHUTDOWN)\b|(?:_all_docs|_design/|_view/|_find)\b)" \
        "t:none,\
        t:urlDecodeUni,\
        t:base64Decode,\
        t:htmlEntityDecode,\
        t:compressWhitespace,\
        t:lowercase"

# ----------------------------------------------------------------------------
# Rule 400012: Mixed Encoding in REQUEST_HEADERS - Base64 → URL
# ----------------------------------------------------------------------------

SecRule REQUEST_HEADERS "@rx ^[A-Za-z0-9+/%]{16,}={0,2}$" \
    "id:400012,\
    phase:2,\
    block,\
    nolog,\
    t:none,\
    msg:'NoSQL Injection with Mixed Encoding (Base64→URL) (Layer 3) - Headers',\
    logdata:'Header: %{MATCHED_VAR_NAME}, Mixed-decoded: %{MATCHED_VAR}',\
    severity:CRITICAL,\
    tag:'attack-nosqli',\
    tag:'attack-polyglot-encoding',\
    tag:'paranoia-level/4',\
    tag:'OWASP_CRS/NOSQLI/MIXED',\
    setvar:'tx.nosql_injection_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}',\
    setvar:'tx.nosqli_encoding_anomaly_score=+3',\
    chain"

    SecRule MATCHED_VAR "@rx (?i)(?:\$(?:where|n(?:e|in|ot|or)|eq|g(?:t|te)|l(?:t|te)|in|exists|regex|type|mod|size|all|elemMatch|set|unset|push|pull|addToSet|inc|rename|group|project|lookup|match|sort)\b|\$(?:or|and|nor)\s*[\[\{:]|(?:function\s*\(|this\.\w+\s*[=!<>]|\beval\s*\(|process\.(?:exit|env|mainModule))|(?:db|collection)\s*\.\s*\w+\s*\.\s*(?:find|insert|update|remove|drop|aggregate)\s*\(|\{\s*['\"]?\$(?:ne|gt|gte|lt|lte|nin)['\"]?\s*:\s*(?:['\"]|null|\[\]|\d)|\b(?:EVAL|EVALSHA)\s+['\"]|\b(?:CONFIG|FLUSHALL|FLUSHDB|DEBUG|SHUTDOWN)\b|(?:_all_docs|_design/|_view/|_find)\b)" \
        "t:none,\
        t:base64Decode,\
        t:urlDecodeUni,\
        t:htmlEntityDecode,\
        t:compressWhitespace,\
        t:lowercase"

# ----------------------------------------------------------------------------
# Rule 400013: Mixed Encoding in REQUEST_HEADERS - URL → Base64
# ----------------------------------------------------------------------------

SecRule REQUEST_HEADERS "@rx ^[A-Za-z0-9+/%]{16,}={0,2}$" \
    "id:400013,\
    phase:2,\
    block,\
    nolog,\
    t:none,\
    msg:'NoSQL Injection with Mixed Encoding (URL→Base64) (Layer 3) - Headers',\
    logdata:'Header: %{MATCHED_VAR_NAME}, Mixed-decoded: %{MATCHED_VAR}',\
    severity:CRITICAL,\
    tag:'attack-nosqli',\
    tag:'attack-polyglot-encoding',\
    tag:'paranoia-level/4',\
    tag:'OWASP_CRS/NOSQLI/MIXED',\
    setvar:'tx.nosql_injection_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}',\
    setvar:'tx.nosqli_encoding_anomaly_score=+3',\
    chain"

    SecRule MATCHED_VAR "@rx (?i)(?:\$(?:where|n(?:e|in|ot|or)|eq|g(?:t|te)|l(?:t|te)|in|exists|regex|type|mod|size|all|elemMatch|set|unset|push|pull|addToSet|inc|rename|group|project|lookup|match|sort)\b|\$(?:or|and|nor)\s*[\[\{:]|(?:function\s*\(|this\.\w+\s*[=!<>]|\beval\s*\(|process\.(?:exit|env|mainModule))|(?:db|collection)\s*\.\s*\w+\s*\.\s*(?:find|insert|update|remove|drop|aggregate)\s*\(|\{\s*['\"]?\$(?:ne|gt|gte|lt|lte|nin)['\"]?\s*:\s*(?:['\"]|null|\[\]|\d)|\b(?:EVAL|EVALSHA)\s+['\"]|\b(?:CONFIG|FLUSHALL|FLUSHDB|DEBUG|SHUTDOWN)\b|(?:_all_docs|_design/|_view/|_find)\b)" \
        "t:none,\
        t:urlDecodeUni,\
        t:base64Decode,\
        t:htmlEntityDecode,\
        t:compressWhitespace,\
        t:lowercase"

# ============================================================================
# LAYER 4: ANOMALY DETECTION
# ============================================================================

# ----------------------------------------------------------------------------
# Rule 400014: Flag Suspicious Nested Encoding
# ----------------------------------------------------------------------------

SecRule ARGS|ARGS_GET|REQUEST_HEADERS "@rx ^(?:[A-Za-z0-9+/]{16,}={0,2})$" \
    "id:400014,\
    phase:2,\
    pass,\
    t:none,\
    t:base64Decode,\
    msg:'Suspicious Nested Encoding Detected (NoSQLi Anomaly)',\
    logdata:'Potential encoding evasion: %{MATCHED_VAR_NAME}',\
    severity:WARNING,\
    tag:'anomaly-detection',\
    tag:'encoding-evasion',\
    tag:'paranoia-level/4',\
    setvar:'tx.nosqli_encoding_anomaly_score=+2',\
    setvar:'tx.inbound_anomaly_score_pl4=+2',\
    chain"

    SecRule MATCHED_VAR "@rx ^(?:[A-Za-z0-9+/]{16,}={0,2})$" \
        "t:none"

# ============================================================================
# END OF GENERALIZED NoSQL INJECTION RULES
# ============================================================================
