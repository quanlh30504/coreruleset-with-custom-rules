# ============================================================================
# OWASP CRS - Generalized XSS Detection Rules
# Rule ID Range: 200001-200020
# ============================================================================
# Purpose: Structure-based XSS detection with intelligent nested decoding
#
# Key Improvements over ID 100001-100013:
# 1. Generalized regex patterns (structure vs enumeration)
# 2. Triple-layer decoding (standard, nested Base64, mixed encoding)
# 3. Normalization pipeline (whitespace, case, HTML entities)
# 4. Anomaly detection for suspicious encoding patterns
# 5. Optional response body scanning (Phase 4)
#
# ============================================================================

# ----------------------------------------------------------------------------
# CONFIGURATION VARIABLES
# ----------------------------------------------------------------------------
# These can be overridden in crs-setup.conf

# Enable nested decoding (0=off, 1=on)
SecAction \
    "id:200000,\
    phase:1,\
    nolog,\
    pass,\
    t:none,\
    setvar:'tx.xss_nested_decoding=1',\
    setvar:'tx.xss_max_decode_depth=2',\
    setvar:'tx.encoding_anomaly_score=3'"

# ============================================================================
# REGEX PATTERN DEFINITION (Generalized Structure-based)
# ============================================================================
# This pattern focuses on XSS STRUCTURE rather than specific function names
#
# Pattern Components:
# 1. HTML Tag-based XSS (script, iframe, object, embed, svg)
# 2. Event Handler XSS (on* attributes)
# 3. Protocol-based XSS (javascript:, data:, vbscript:)
# 4. DOM Manipulation (document.*, window.*)
# 5. Code Execution Functions (eval, alert, etc + generic patterns)
# 6. Template Injection patterns
#
# Key: Uses \s* to handle whitespace obfuscation
# ============================================================================

# Define the core XSS detection pattern as a macro for reusability
# Note: ModSecurity doesn't support macros natively, so we'll use the pattern directly

# ============================================================================
# LAYER 1: STANDARD DECODING + DETECTION
# ============================================================================
# Single-layer Base64 decode with normalization
# Variables: REQUEST_URI, ARGS_GET, ARGS_POST, REQUEST_HEADERS
# ============================================================================

# ----------------------------------------------------------------------------
# Rule 200001: XSS Detection in REQUEST_URI (URL Path)
# ----------------------------------------------------------------------------
# Captures the last segment of URL path and checks for XSS patterns
# Auto URL-decoded by ModSecurity, needs Base64 + normalization

SecRule REQUEST_URI "@rx ^.*/([^/]+)$" \
    "id:200001,\
    phase:2,\
    pass,\
    nolog,\
    capture,\
    t:none,\
    setvar:'tx.urlpath_payload=%{TX.1}',\
    chain"

    SecRule TX:urlpath_payload "@rx (?i)(?:<\s*(?:script|iframe|object|embed|svg|img|input|form|body|html|link|meta|base|style)\s*[^>]*(?:\s+on\w+\s*=|src\s*=\s*['\"]?\s*(?:javascript|data|vbscript|view-source)\s*:|style\s*=\s*['\"]?.*?expression)|<\s*[a-z0-9:-]+\s+[^>]*on\w+\s*=|(?:javascript|data|vbscript):\s*|(?:document\s*\.\s*(?:cookie|domain|write|location)|window\s*\.\s*location|eval|alert|prompt|confirm|setTimeout|setInterval|Function|constructor)\s*[\[\(]|<\s*script\s*[^>]*>)" \
        "t:none,\
        t:urlDecodeUni,\
        t:base64Decode,\
        t:htmlEntityDecode,\
        t:compressWhitespace,\
        t:lowercase,\
        block,\
        msg:'XSS Attack Detected in URL Path (Layer 1)',\
        logdata:'Payload: %{MATCHED_VAR}',\
        severity:CRITICAL,\
        tag:'attack-xss',\
        tag:'paranoia-level/4',\
        tag:'OWASP_CRS/XSS/GENERALIZED',\
        setvar:'tx.xss_score=+%{tx.critical_anomaly_score}',\
        setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}'"

# ----------------------------------------------------------------------------
# Rule 200002: XSS Detection in ARGS_GET (URL Parameters)
# ----------------------------------------------------------------------------
# URL parameters are auto URL-decoded, check Base64 + normalization

SecRule ARGS_GET "@rx (?i)(?:<\s*(?:script|iframe|object|embed|svg|img|input|form|body|html|link|meta|base|style)\s*[^>]*(?:\s+on\w+\s*=|src\s*=\s*['\"]?\s*(?:javascript|data|vbscript|view-source)\s*:|style\s*=\s*['\"]?.*?expression)|<\s*[a-z0-9:-]+\s+[^>]*on\w+\s*=|(?:javascript|data|vbscript):\s*|(?:document\s*\.\s*(?:cookie|domain|write|location)|window\s*\.\s*location|eval|alert|prompt|confirm|setTimeout|setInterval|Function|constructor)\s*[\[\(]|<\s*script\s*[^>]*>)" \
    "id:200002,\
    phase:2,\
    t:none,\
    t:base64Decode,\
    t:htmlEntityDecode,\
    t:compressWhitespace,\
    t:lowercase,\
    block,\
    msg:'XSS Attack Detected in URL Parameters (Layer 1)',\
    logdata:'Parameter: %{MATCHED_VAR_NAME}, Payload: %{MATCHED_VAR}',\
    severity:CRITICAL,\
    tag:'attack-xss',\
    tag:'paranoia-level/4',\
    tag:'OWASP_CRS/XSS/GENERALIZED',\
    setvar:'tx.xss_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}'"

# ----------------------------------------------------------------------------
# Rule 200003: XSS Detection in ARGS (POST Body / Form Data / JSON)
# ----------------------------------------------------------------------------
# Handles POST data (auto URL-decoded) and JSON (requires JSON body processor)

SecRule ARGS "@rx (?i)(?:<\s*(?:script|iframe|object|embed|svg|img|input|form|body|html|link|meta|base|style)\s*[^>]*(?:\s+on\w+\s*=|src\s*=\s*['\"]?\s*(?:javascript|data|vbscript|view-source)\s*:|style\s*=\s*['\"]?.*?expression)|<\s*[a-z0-9:-]+\s+[^>]*on\w+\s*=|(?:javascript|data|vbscript):\s*|(?:document\s*\.\s*(?:cookie|domain|write|location)|window\s*\.\s*location|eval|alert|prompt|confirm|setTimeout|setInterval|Function|constructor)\s*[\[\(]|<\s*script\s*[^>]*>)" \
    "id:200003,\
    phase:2,\
    t:none,\
    t:base64Decode,\
    t:htmlEntityDecode,\
    t:compressWhitespace,\
    t:lowercase,\
    block,\
    msg:'XSS Attack Detected in POST/JSON Data (Layer 1)',\
    logdata:'Parameter: %{MATCHED_VAR_NAME}, Payload: %{MATCHED_VAR}',\
    severity:CRITICAL,\
    tag:'attack-xss',\
    tag:'paranoia-level/4',\
    tag:'OWASP_CRS/XSS/GENERALIZED',\
    setvar:'tx.xss_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}'"

# ----------------------------------------------------------------------------
# Rule 200004: XSS Detection in REQUEST_HEADERS (All Headers)
# ----------------------------------------------------------------------------
# Headers are NOT auto URL-decoded, needs manual URL decode + Base64

SecRule REQUEST_HEADERS "@rx (?i)(?:<\s*(?:script|iframe|object|embed|svg|img|input|form|body|html|link|meta|base|style)\s*[^>]*(?:\s+on\w+\s*=|src\s*=\s*['\"]?\s*(?:javascript|data|vbscript|view-source)\s*:|style\s*=\s*['\"]?.*?expression)|<\s*[a-z0-9:-]+\s+[^>]*on\w+\s*=|(?:javascript|data|vbscript):\s*|(?:document\s*\.\s*(?:cookie|domain|write|location)|window\s*\.\s*location|eval|alert|prompt|confirm|setTimeout|setInterval|Function|constructor)\s*[\[\(]|<\s*script\s*[^>]*>)" \
    "id:200004,\
    phase:2,\
    t:none,\
    t:urlDecodeUni,\
    t:base64Decode,\
    t:htmlEntityDecode,\
    t:compressWhitespace,\
    t:lowercase,\
    block,\
    msg:'XSS Attack Detected in HTTP Headers (Layer 1)',\
    logdata:'Header: %{MATCHED_VAR_NAME}, Payload: %{MATCHED_VAR}',\
    severity:CRITICAL,\
    tag:'attack-xss',\
    tag:'paranoia-level/4',\
    tag:'OWASP_CRS/XSS/GENERALIZED',\
    setvar:'tx.xss_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}'"

# ============================================================================
# LAYER 2: NESTED BASE64 DETECTION
# ============================================================================
# Strategy: "Onion Peeling"
# 1. Check if value is Base64-like
# 2. Decode once
# 3. Check if RESULT is still Base64-like (nested!)
# 4. Decode AGAIN
# 5. Apply XSS detection
#
# Performance: Only triggered when nested encoding detected
# ============================================================================

# ----------------------------------------------------------------------------
# Rule 200005: Nested Base64 in ARGS_GET
# ----------------------------------------------------------------------------
# Detects Base64(Base64(XSS)) patterns

SecRule ARGS_GET "@rx ^[A-Za-z0-9+/]{16,}={0,2}$" \
    "id:200005,\
    phase:2,\
    pass,\
    nolog,\
    t:none,\
    capture,\
    setvar:'tx.potential_nested_b64=%{MATCHED_VAR}',\
    chain"

    # First decode
    SecRule TX:potential_nested_b64 "@rx ^[A-Za-z0-9+/]{16,}={0,2}$" \
        "t:base64Decode,\
        pass,\
        nolog,\
        setvar:'tx.nested_decoded_once=%{MATCHED_VAR}',\
        chain"

        # Second decode + XSS check
        SecRule TX:nested_decoded_once "@rx (?i)(?:<\s*(?:script|iframe|object|embed|svg|img|input|form|body|html|link|meta|base|style)\s*[^>]*(?:\s+on\w+\s*=|src\s*=\s*['\"]?\s*(?:javascript|data|vbscript|view-source)\s*:|style\s*=\s*['\"]?.*?expression)|<\s*[a-z0-9:-]+\s+[^>]*on\w+\s*=|(?:javascript|data|vbscript):\s*|(?:document\s*\.\s*(?:cookie|domain|write|location)|window\s*\.\s*location|eval|alert|prompt|confirm|setTimeout|setInterval|Function|constructor)\s*[\[\(]|<\s*script\s*[^>]*>)" \
            "t:none,\
            t:base64Decode,\
            t:htmlEntityDecode,\
            t:compressWhitespace,\
            t:lowercase,\
            block,\
            msg:'XSS Attack with Nested Base64 Encoding Detected (Layer 2) - URL Param',\
            logdata:'Double-decoded payload: %{MATCHED_VAR}',\
            severity:CRITICAL,\
            tag:'attack-xss',\
            tag:'attack-encoding-evasion',\
            tag:'paranoia-level/4',\
            tag:'OWASP_CRS/XSS/NESTED',\
            setvar:'tx.xss_score=+%{tx.critical_anomaly_score}',\
            setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}',\
            setvar:'tx.encoding_anomaly_score=+2'"

# ----------------------------------------------------------------------------
# Rule 200006: Nested Base64 in ARGS (POST/JSON)
# ----------------------------------------------------------------------------

SecRule ARGS "@rx ^[A-Za-z0-9+/]{16,}={0,2}$" \
    "id:200006,\
    phase:2,\
    pass,\
    nolog,\
    t:none,\
    capture,\
    setvar:'tx.potential_nested_b64=%{MATCHED_VAR}',\
    chain"

    SecRule TX:potential_nested_b64 "@rx ^[A-Za-z0-9+/]{16,}={0,2}$" \
        "t:base64Decode,\
        pass,\
        nolog,\
        setvar:'tx.nested_decoded_once=%{MATCHED_VAR}',\
        chain"

        SecRule TX:nested_decoded_once "@rx (?i)(?:<\s*(?:script|iframe|object|embed|svg|img|input|form|body|html|link|meta|base|style)\s*[^>]*(?:\s+on\w+\s*=|src\s*=\s*['\"]?\s*(?:javascript|data|vbscript|view-source)\s*:|style\s*=\s*['\"]?.*?expression)|<\s*[a-z0-9:-]+\s+[^>]*on\w+\s*=|(?:javascript|data|vbscript):\s*|(?:document\s*\.\s*(?:cookie|domain|write|location)|window\s*\.\s*location|eval|alert|prompt|confirm|setTimeout|setInterval|Function|constructor)\s*[\[\(]|<\s*script\s*[^>]*>)" \
            "t:none,\
            t:base64Decode,\
            t:htmlEntityDecode,\
            t:compressWhitespace,\
            t:lowercase,\
            block,\
            msg:'XSS Attack with Nested Base64 Encoding Detected (Layer 2) - POST/JSON',\
            logdata:'Double-decoded payload: %{MATCHED_VAR}',\
            severity:CRITICAL,\
            tag:'attack-xss',\
            tag:'attack-encoding-evasion',\
            tag:'paranoia-level/4',\
            tag:'OWASP_CRS/XSS/NESTED',\
            setvar:'tx.xss_score=+%{tx.critical_anomaly_score}',\
            setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}',\
            setvar:'tx.encoding_anomaly_score=+2'"

# ----------------------------------------------------------------------------
# Rule 200007: Nested Base64 in REQUEST_HEADERS
# ----------------------------------------------------------------------------

SecRule REQUEST_HEADERS "@rx ^[A-Za-z0-9+/]{16,}={0,2}$" \
    "id:200007,\
    phase:2,\
    pass,\
    nolog,\
    t:none,\
    capture,\
    setvar:'tx.potential_nested_b64=%{MATCHED_VAR}',\
    chain"

    SecRule TX:potential_nested_b64 "@rx ^[A-Za-z0-9+/]{16,}={0,2}$" \
        "t:base64Decode,\
        pass,\
        nolog,\
        setvar:'tx.nested_decoded_once=%{MATCHED_VAR}',\
        chain"

        SecRule TX:nested_decoded_once "@rx (?i)(?:<\s*(?:script|iframe|object|embed|svg|img|input|form|body|html|link|meta|base|style)\s*[^>]*(?:\s+on\w+\s*=|src\s*=\s*['\"]?\s*(?:javascript|data|vbscript|view-source)\s*:|style\s*=\s*['\"]?.*?expression)|<\s*[a-z0-9:-]+\s+[^>]*on\w+\s*=|(?:javascript|data|vbscript):\s*|(?:document\s*\.\s*(?:cookie|domain|write|location)|window\s*\.\s*location|eval|alert|prompt|confirm|setTimeout|setInterval|Function|constructor)\s*[\[\(]|<\s*script\s*[^>]*>)" \
            "t:none,\
            t:urlDecodeUni,\
            t:base64Decode,\
            t:htmlEntityDecode,\
            t:compressWhitespace,\
            t:lowercase,\
            block,\
            msg:'XSS Attack with Nested Base64 Encoding Detected (Layer 2) - Headers',\
            logdata:'Header: %{MATCHED_VAR_NAME}, Double-decoded: %{MATCHED_VAR}',\
            severity:CRITICAL,\
            tag:'attack-xss',\
            tag:'attack-encoding-evasion',\
            tag:'paranoia-level/4',\
            tag:'OWASP_CRS/XSS/NESTED',\
            setvar:'tx.xss_score=+%{tx.critical_anomaly_score}',\
            setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}',\
            setvar:'tx.encoding_anomaly_score=+2'"

# ============================================================================
# LAYER 3: MIXED/POLYGLOT ENCODING DETECTION
# ============================================================================
# Handles: Base64(URL_Encode(XSS)) or URL_Encode(Base64(XSS))
# Common in advanced evasion techniques
# ============================================================================

# ----------------------------------------------------------------------------
# Rule 200009-A: Mixed Encoding in ARGS_GET (Base64 → URL order)
# ----------------------------------------------------------------------------

SecRule ARGS_GET "@rx ^[A-Za-z0-9+/%]{16,}={0,2}$" \
    "id:200009,\
    phase:2,\
    pass,\
    nolog,\
    t:none,\
    chain"

    SecRule MATCHED_VAR "@rx (?i)(?:<\s*(?:script|iframe|object|embed|svg|img|input|form|body|html|link|meta|base|style)\s*[^>]*(?:\s+on\w+\s*=|src\s*=\s*['\"]?\s*(?:javascript|data|vbscript|view-source)\s*:|style\s*=\s*['\"]?.*?expression)|<\s*[a-z0-9:-]+\s+[^>]*on\w+\s*=|(?:javascript|data|vbscript):\s*|(?:document\s*\.\s*(?:cookie|domain|write|location)|window\s*\.\s*location|eval|alert|prompt|confirm|setTimeout|setInterval|Function|constructor)\s*[\[\(]|<\s*script\s*[^>]*>)" \
        "t:none,\
        t:base64Decode,\
        t:urlDecodeUni,\
        t:htmlEntityDecode,\
        t:compressWhitespace,\
        t:lowercase,\
        block,\
        msg:'XSS Attack with Mixed Encoding (Base64→URL) Detected (Layer 3) - URL Param',\
        logdata:'Mixed-decoded payload: %{MATCHED_VAR}',\
        severity:CRITICAL,\
        tag:'attack-xss',\
        tag:'attack-polyglot-encoding',\
        tag:'paranoia-level/4',\
        tag:'OWASP_CRS/XSS/MIXED',\
        setvar:'tx.xss_score=+%{tx.critical_anomaly_score}',\
        setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}',\
        setvar:'tx.encoding_anomaly_score=+3'"

# ----------------------------------------------------------------------------
# Rule 200009-B: Mixed Encoding in ARGS_GET (URL → Base64 order)
# ----------------------------------------------------------------------------

SecRule ARGS_GET "@rx ^[A-Za-z0-9+/%]{16,}={0,2}$" \
    "id:200008,\
    phase:2,\
    pass,\
    nolog,\
    t:none,\
    chain"

    SecRule MATCHED_VAR "@rx (?i)(?:<\s*(?:script|iframe|object|embed|svg|img|input|form|body|html|link|meta|base|style)\s*[^>]*(?:\s+on\w+\s*=|src\s*=\s*['\"]?\s*(?:javascript|data|vbscript|view-source)\s*:|style\s*=\s*['\"]?.*?expression)|<\s*[a-z0-9:-]+\s+[^>]*on\w+\s*=|(?:javascript|data|vbscript):\s*|(?:document\s*\.\s*(?:cookie|domain|write|location)|window\s*\.\s*location|eval|alert|prompt|confirm|setTimeout|setInterval|Function|constructor)\s*[\[\(]|<\s*script\s*[^>]*>)" \
        "t:none,\
        t:urlDecodeUni,\
        t:base64Decode,\
        t:htmlEntityDecode,\
        t:compressWhitespace,\
        t:lowercase,\
        block,\
        msg:'XSS Attack with Mixed Encoding (URL→Base64) Detected (Layer 3) - URL Param',\
        logdata:'Mixed-decoded payload: %{MATCHED_VAR}',\
        severity:CRITICAL,\
        tag:'attack-xss',\
        tag:'attack-polyglot-encoding',\
        tag:'paranoia-level/4',\
        tag:'OWASP_CRS/XSS/MIXED',\
        setvar:'tx.xss_score=+%{tx.critical_anomaly_score}',\
        setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}',\
        setvar:'tx.encoding_anomaly_score=+3'"


# ----------------------------------------------------------------------------
# Rule 200010-A: Mixed Encoding in ARGS (POST/JSON) - Base64 → URL order
# ----------------------------------------------------------------------------

SecRule ARGS "@rx ^[A-Za-z0-9+/%]{16,}={0,2}$" \
    "id:200010,\
    phase:2,\
    pass,\
    nolog,\
    t:none,\
    chain"

    SecRule MATCHED_VAR "@rx (?i)(?:<\s*(?:script|iframe|object|embed|svg|img|input|form|body|html|link|meta|base|style)\s*[^>]*(?:\s+on\w+\s*=|src\s*=\s*['\"]?\s*(?:javascript|data|vbscript|view-source)\s*:|style\s*=\s*['\"]?.*?expression)|<\s*[a-z0-9:-]+\s+[^>]*on\w+\s*=|(?:javascript|data|vbscript):\s*|(?:document\s*\.\s*(?:cookie|domain|write|location)|window\s*\.\s*location|eval|alert|prompt|confirm|setTimeout|setInterval|Function|constructor)\s*[\[\(]|<\s*script\s*[^>]*>)" \
        "t:none,\
        t:base64Decode,\
        t:urlDecodeUni,\
        t:htmlEntityDecode,\
        t:compressWhitespace,\
        t:lowercase,\
        block,\
        msg:'XSS Attack with Mixed Encoding (Base64→URL) Detected (Layer 3) - POST/JSON',\
        logdata:'Mixed-decoded payload: %{MATCHED_VAR}',\
        severity:CRITICAL,\
        tag:'attack-xss',\
        tag:'attack-polyglot-encoding',\
        tag:'paranoia-level/4',\
        tag:'OWASP_CRS/XSS/MIXED',\
        setvar:'tx.xss_score=+%{tx.critical_anomaly_score}',\
        setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}',\
        setvar:'tx.encoding_anomaly_score=+3'"

# ----------------------------------------------------------------------------
# Rule 200010-B: Mixed Encoding in ARGS (POST/JSON) - URL → Base64 order
# ----------------------------------------------------------------------------

SecRule ARGS "@rx ^[A-Za-z0-9+/%]{16,}={0,2}$" \
    "id:200012,\
    phase:2,\
    pass,\
    nolog,\
    t:none,\
    chain"

    SecRule MATCHED_VAR "@rx (?i)(?:<\s*(?:script|iframe|object|embed|svg|img|input|form|body|html|link|meta|base|style)\s*[^>]*(?:\s+on\w+\s*=|src\s*=\s*['\"]?\s*(?:javascript|data|vbscript|view-source)\s*:|style\s*=\s*['\"]?.*?expression)|<\s*[a-z0-9:-]+\s+[^>]*on\w+\s*=|(?:javascript|data|vbscript):\s*|(?:document\s*\.\s*(?:cookie|domain|write|location)|window\s*\.\s*location|eval|alert|prompt|confirm|setTimeout|setInterval|Function|constructor)\s*[\[\(]|<\s*script\s*[^>]*>)" \
        "t:none,\
        t:urlDecodeUni,\
        t:base64Decode,\
        t:htmlEntityDecode,\
        t:compressWhitespace,\
        t:lowercase,\
        block,\
        msg:'XSS Attack with Mixed Encoding (URL→Base64) Detected (Layer 3) - POST/JSON',\
        logdata:'Mixed-decoded payload: %{MATCHED_VAR}',\
        severity:CRITICAL,\
        tag:'attack-xss',\
        tag:'attack-polyglot-encoding',\
        tag:'paranoia-level/4',\
        tag:'OWASP_CRS/XSS/MIXED',\
        setvar:'tx.xss_score=+%{tx.critical_anomaly_score}',\
        setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}',\
        setvar:'tx.encoding_anomaly_score=+3'"


# ----------------------------------------------------------------------------
# Rule 200011-A: Mixed Encoding in REQUEST_HEADERS - Base64 → URL order
# ----------------------------------------------------------------------------

SecRule REQUEST_HEADERS "@rx ^[A-Za-z0-9+/%]{16,}={0,2}$" \
    "id:200011,\
    phase:2,\
    pass,\
    nolog,\
    t:none,\
    chain"

    SecRule MATCHED_VAR "@rx (?i)(?:<\s*(?:script|iframe|object|embed|svg|img|input|form|body|html|link|meta|base|style)\s*[^>]*(?:\s+on\w+\s*=|src\s*=\s*['\"]?\s*(?:javascript|data|vbscript|view-source)\s*:|style\s*=\s*['\"]?.*?expression)|<\s*[a-z0-9:-]+\s+[^>]*on\w+\s*=|(?:javascript|data|vbscript):\s*|(?:document\s*\.\s*(?:cookie|domain|write|location)|window\s*\.\s*location|eval|alert|prompt|confirm|setTimeout|setInterval|Function|constructor)\s*[\[\(]|<\s*script\s*[^>]*>)" \
        "t:none,\
        t:base64Decode,\
        t:urlDecodeUni,\
        t:htmlEntityDecode,\
        t:compressWhitespace,\
        t:lowercase,\
        block,\
        msg:'XSS Attack with Mixed Encoding (Base64→URL) Detected (Layer 3) - Headers',\
        logdata:'Header: %{MATCHED_VAR_NAME}, Mixed-decoded: %{MATCHED_VAR}',\
        severity:CRITICAL,\
        tag:'attack-xss',\
        tag:'attack-polyglot-encoding',\
        tag:'paranoia-level/4',\
        tag:'OWASP_CRS/XSS/MIXED',\
        setvar:'tx.xss_score=+%{tx.critical_anomaly_score}',\
        setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}',\
        setvar:'tx.encoding_anomaly_score=+3'"

# ----------------------------------------------------------------------------
# Rule 200011-B: Mixed Encoding in REQUEST_HEADERS - URL → Base64 order
# ----------------------------------------------------------------------------

SecRule REQUEST_HEADERS "@rx ^[A-Za-z0-9+/%]{16,}={0,2}$" \
    "id:200014,\
    phase:2,\
    pass,\
    nolog,\
    t:none,\
    chain"

    SecRule MATCHED_VAR "@rx (?i)(?:<\s*(?:script|iframe|object|embed|svg|img|input|form|body|html|link|meta|base|style)\s*[^>]*(?:\s+on\w+\s*=|src\s*=\s*['\"]?\s*(?:javascript|data|vbscript|view-source)\s*:|style\s*=\s*['\"]?.*?expression)|<\s*[a-z0-9:-]+\s+[^>]*on\w+\s*=|(?:javascript|data|vbscript):\s*|(?:document\s*\.\s*(?:cookie|domain|write|location)|window\s*\.\s*location|eval|alert|prompt|confirm|setTimeout|setInterval|Function|constructor)\s*[\[\(]|<\s*script\s*[^>]*>)" \
        "t:none,\
        t:urlDecodeUni,\
        t:base64Decode,\
        t:htmlEntityDecode,\
        t:compressWhitespace,\
        t:lowercase,\
        block,\
        msg:'XSS Attack with Mixed Encoding (URL→Base64) Detected (Layer 3) - Headers',\
        logdata:'Header: %{MATCHED_VAR_NAME}, Mixed-decoded: %{MATCHED_VAR}',\
        severity:CRITICAL,\
        tag:'attack-xss',\
        tag:'attack-polyglot-encoding',\
        tag:'paranoia-level/4',\
        tag:'OWASP_CRS/XSS/MIXED',\
        setvar:'tx.xss_score=+%{tx.critical_anomaly_score}',\
        setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}',\
        setvar:'tx.encoding_anomaly_score=+3'"


# ============================================================================
# ANOMALY DETECTION: Suspicious Encoding Patterns
# ============================================================================
# Even if XSS pattern is not detected, flag suspicious behavior
# Why would normal input be triple-nested Base64?
# ============================================================================

# ----------------------------------------------------------------------------
# Rule 200013: Flag Suspicious Nested Encoding (No malicious pattern yet)
# ----------------------------------------------------------------------------
# This raises anomaly score when we detect complex encoding without XSS
# Helps catch zero-day or obfuscated attacks

SecRule ARGS|ARGS_GET|REQUEST_HEADERS "@rx ^(?:[A-Za-z0-9+/]{16,}={0,2})$" \
    "id:200013,\
    phase:2,\
    t:none,\
    t:base64Decode,\
    chain"

    SecRule MATCHED_VAR "@rx ^(?:[A-Za-z0-9+/]{16,}={0,2})$" \
        "pass,\
        msg:'Suspicious Nested Encoding Detected (Anomaly)',\
        logdata:'Potential encoding evasion attempt: %{MATCHED_VAR_NAME}',\
        severity:WARNING,\
        tag:'anomaly-detection',\
        tag:'encoding-evasion',\
        tag:'paranoia-level/4',\
        setvar:'tx.encoding_anomaly_score=+2',\
        setvar:'tx.inbound_anomaly_score_pl4=+2'"

# ============================================================================
# OPTIONAL: RESPONSE BODY SCANNING (Phase 4)
# ============================================================================
# Sometimes XSS bypasses request filtering but appears in response
# WARNING: Performance impact! Enable only if needed
# ============================================================================

# Uncomment to enable response scanning
# SecRule RESPONSE_BODY "@rx (?i)(?:<\s*script[^>]*>|javascript:|eval\s*\(|document\s*\.\s*cookie)" \
#     "id:200015,\
#     phase:4,\
#     t:none,\
#     t:htmlEntityDecode,\
#     t:compressWhitespace,\
#     t:lowercase,\
#     block,\
#     msg:'XSS Pattern Detected in Response Body',\
#     logdata:'Response contains potential XSS: %{MATCHED_VAR}',\
#     severity:ERROR,\
#     tag:'attack-xss',\
#     tag:'response-inspection',\
#     tag:'paranoia-level/4'"

# ============================================================================
# END OF GENERALIZED XSS RULES
# ============================================================================
