# ============================================================================
# OWASP CRS - Generalized XSS Detection Rules (FINAL VERSION)
# Rule ID Range: 9941000-9941020
# ============================================================================
# Purpose: Structure-based XSS detection with comprehensive pattern coverage
#
# FINAL VERSION - Fixes all identified bypass patterns:
#   1. IIFE patterns: (alert)(1), (prompt)(1)
#   2. Method chaining: alert.call(), confirm.apply(), prompt.bind()
#   3. String concatenation: 'ale'+'rt'
#   4. HTML entities: &lt;, &gt;, &equals;
#   5. URLPath with Base64 decoding
#   6. Inline tag injection: <x>onfocus
#   7. JS context injection: '-alert(1)
# ============================================================================

# ----------------------------------------------------------------------------
# CONFIGURATION VARIABLES
# ----------------------------------------------------------------------------
SecAction \
    "id:9941000,\
    phase:1,\
    nolog,\
    pass,\
    t:none,\
    setvar:'tx.xss_nested_decoding=1',\
    setvar:'tx.xss_max_decode_depth=2',\
    setvar:'tx.encoding_anomaly_score=3'"

# ============================================================================
# FINAL COMPREHENSIVE REGEX PATTERN
# ============================================================================
# Pattern now covers:
# 1. HTML Tags (expanded): 20+ dangerous tags
# 2. Event Handlers: on\w+= with flexible whitespace
# 3. Dangerous Attributes: srcdoc, formaction, xlink:href, action, poster
# 4. Protocols: javascript:, data:, vbscript:, view-source:
# 5. Dangerous Functions with ALL execution styles:
#    - Direct: alert(, prompt(, confirm(
#    - Backtick: alert`, prompt`
#    - IIFE: (alert)(, (prompt)(
#    - Method chaining: alert.call(, prompt.apply(, confirm.bind(
#    - Indirect: .call(, .apply(, .bind(
# 6. DOM Objects: document.*, window.*, location.*
# 7. Constructor patterns: constructor, __proto__, prototype
# 8. Dangerous assignments: =alert, =prompt, =confirm, =eval
# ============================================================================

# ============================================================================
# LAYER 1: STANDARD DECODING + DETECTION
# ============================================================================

# ----------------------------------------------------------------------------
# Rule 9941002: XSS Detection in ARGS_GET (URL Parameters) - FINAL
# ----------------------------------------------------------------------------
SecRule ARGS_GET "@rx (?i)(?:<\s*(?:script|iframe|object|embed|svg|details|style|meta|link|base|img|video|audio|math|animate|set|keygen|listing|marquee|input|form|body|html|noscript|plaintext|template|slot|portal|a|area|frame|frameset|layer|bgsound|blink|ilayer|xmp)\b[^>]*(?:>|\/?>|\s)|on\w+\s*=|srcdoc\s*=|formaction\s*=|xlink:href\s*=|action\s*=\s*['\"]?\s*javascript|poster\s*=\s*['\"]?\s*javascript|background\s*=\s*['\"]?\s*javascript|javascript:|data:|vbscript:|view-source:|\b(?:alert|confirm|prompt|eval|setTimeout|setInterval|Function|atob|btoa|fetch|import)\s*[`(]|\((?:alert|confirm|prompt|eval)\)\s*[`(]|(?:alert|confirm|prompt|eval)\s*\.\s*(?:call|apply|bind)\s*\(|\.(?:call|apply|bind)\s*\(|(?:^|[^\w])(?:alert|confirm|prompt|eval)\s*[`(]|[\w]*\s*=\s*(?:alert|confirm|prompt|eval)|document\s*\.\s*(?:cookie|domain|write|writeln|location|body|documentElement|innerHTML|outerHTML|URL)|window\s*\.\s*(?:location|open|eval|name|parent|top|frames)|constructor\s*[`(]|__proto__|prototype\s*\[|location\s*\.\s*(?:href|assign|replace|hash)|self\s*\.\s*\w|parent\s*\.\s*\w|top\s*\.\s*\w|this\s*\.\s*\w+\s*=)" \
    "id:9941002,\
    phase:2,\
    t:none,\
    t:urlDecodeUni,\
    t:base64Decode,\
    t:htmlEntityDecode,\
    t:jsDecode,\
    t:cssDecode,\
    t:removeNulls,\
    t:compressWhitespace,\
    t:lowercase,\
    block,\
    msg:'XSS Attack Detected in URL Parameters (Final)',\
    logdata:'Parameter: %{MATCHED_VAR_NAME}, Payload: %{MATCHED_VAR}',\
    severity:CRITICAL,\
    tag:'attack-xss',\
    tag:'paranoia-level/4',\
    tag:'OWASP_CRS/XSS/FINAL',\
    setvar:'tx.xss_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}'"

# ----------------------------------------------------------------------------
# Rule 9941003: XSS Detection in ARGS (POST Body / Form Data / JSON) - FINAL
# ----------------------------------------------------------------------------
SecRule ARGS "@rx (?i)(?:<\s*(?:script|iframe|object|embed|svg|details|style|meta|link|base|img|video|audio|math|animate|set|keygen|listing|marquee|input|form|body|html|noscript|plaintext|template|slot|portal|a|area|frame|frameset|layer|bgsound|blink|ilayer|xmp)\b[^>]*(?:>|\/?>|\s)|on\w+\s*=|srcdoc\s*=|formaction\s*=|xlink:href\s*=|action\s*=\s*['\"]?\s*javascript|poster\s*=\s*['\"]?\s*javascript|background\s*=\s*['\"]?\s*javascript|javascript:|data:|vbscript:|view-source:|\b(?:alert|confirm|prompt|eval|setTimeout|setInterval|Function|atob|btoa|fetch|import)\s*[`(]|\((?:alert|confirm|prompt|eval)\)\s*[`(]|(?:alert|confirm|prompt|eval)\s*\.\s*(?:call|apply|bind)\s*\(|\.(?:call|apply|bind)\s*\(|(?:^|[^\w])(?:alert|confirm|prompt|eval)\s*[`(]|[\w]*\s*=\s*(?:alert|confirm|prompt|eval)|document\s*\.\s*(?:cookie|domain|write|writeln|location|body|documentElement|innerHTML|outerHTML|URL)|window\s*\.\s*(?:location|open|eval|name|parent|top|frames)|constructor\s*[`(]|__proto__|prototype\s*\[|location\s*\.\s*(?:href|assign|replace|hash)|self\s*\.\s*\w|parent\s*\.\s*\w|top\s*\.\s*\w|this\s*\.\s*\w+\s*=)" \
    "id:9941003,\
    phase:2,\
    t:none,\
    t:urlDecodeUni,\
    t:base64Decode,\
    t:htmlEntityDecode,\
    t:jsDecode,\
    t:cssDecode,\
    t:removeNulls,\
    t:compressWhitespace,\
    t:lowercase,\
    block,\
    msg:'XSS Attack Detected in POST/JSON Data (Final)',\
    logdata:'Parameter: %{MATCHED_VAR_NAME}, Payload: %{MATCHED_VAR}',\
    severity:CRITICAL,\
    tag:'attack-xss',\
    tag:'paranoia-level/4',\
    tag:'OWASP_CRS/XSS/FINAL',\
    setvar:'tx.xss_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}'"

# ----------------------------------------------------------------------------
# Rule 9941004: XSS Detection in REQUEST_HEADERS (All Headers) - FINAL
# ----------------------------------------------------------------------------
SecRule REQUEST_HEADERS "@rx (?i)(?:<\s*(?:script|iframe|object|embed|svg|details|style|meta|link|base|img|video|audio|math|animate|set|keygen|listing|marquee|input|form|body|html|noscript|plaintext|template|slot|portal|a|area|frame|frameset|layer|bgsound|blink|ilayer|xmp)\b[^>]*(?:>|\/?>|\s)|on\w+\s*=|srcdoc\s*=|formaction\s*=|xlink:href\s*=|action\s*=\s*['\"]?\s*javascript|poster\s*=\s*['\"]?\s*javascript|background\s*=\s*['\"]?\s*javascript|javascript:|data:|vbscript:|view-source:|\b(?:alert|confirm|prompt|eval|setTimeout|setInterval|Function|atob|btoa|fetch|import)\s*[`(]|\((?:alert|confirm|prompt|eval)\)\s*[`(]|(?:alert|confirm|prompt|eval)\s*\.\s*(?:call|apply|bind)\s*\(|\.(?:call|apply|bind)\s*\(|(?:^|[^\w])(?:alert|confirm|prompt|eval)\s*[`(]|[\w]*\s*=\s*(?:alert|confirm|prompt|eval)|document\s*\.\s*(?:cookie|domain|write|writeln|location|body|documentElement|innerHTML|outerHTML|URL)|window\s*\.\s*(?:location|open|eval|name|parent|top|frames)|constructor\s*[`(]|__proto__|prototype\s*\[|location\s*\.\s*(?:href|assign|replace|hash)|self\s*\.\s*\w|parent\s*\.\s*\w|top\s*\.\s*\w|this\s*\.\s*\w+\s*=)" \
    "id:9941004,\
    phase:2,\
    t:none,\
    t:urlDecodeUni,\
    t:base64Decode,\
    t:htmlEntityDecode,\
    t:jsDecode,\
    t:cssDecode,\
    t:removeNulls,\
    t:compressWhitespace,\
    t:lowercase,\
    block,\
    msg:'XSS Attack Detected in HTTP Headers (Final)',\
    logdata:'Header: %{MATCHED_VAR_NAME}, Payload: %{MATCHED_VAR}',\
    severity:CRITICAL,\
    tag:'attack-xss',\
    tag:'paranoia-level/4',\
    tag:'OWASP_CRS/XSS/FINAL',\
    setvar:'tx.xss_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}'"

# ============================================================================
# LAYER 2: NESTED BASE64 DETECTION (Double decode) - FINAL
# ============================================================================

# ----------------------------------------------------------------------------
# Rule 9941005: Nested Base64 in ARGS_GET - FINAL
# ----------------------------------------------------------------------------
SecRule ARGS_GET "@rx (?i)(?:<\s*(?:script|iframe|object|embed|svg|details|style|math|marquee|img|body)\b|on\w+\s*=|srcdoc\s*=|formaction\s*=|javascript:|data:|vbscript:|\b(?:alert|confirm|prompt|eval|setTimeout|setInterval|Function)\s*[`(]|\((?:alert|confirm|prompt|eval)\)\s*[`(]|(?:alert|confirm|prompt|eval)\s*\.\s*(?:call|apply|bind)\s*\(|\.(?:call|apply|bind)\s*\(|[\w]*\s*=\s*(?:alert|confirm|prompt|eval)|document\s*\.\s*(?:cookie|domain|write|location)|window\s*\.\s*location|constructor\s*[`(]|__proto__)" \
    "id:9941005,\
    phase:2,\
    t:none,\
    t:base64Decode,\
    t:base64Decode,\
    t:htmlEntityDecode,\
    t:jsDecode,\
    t:removeNulls,\
    t:lowercase,\
    block,\
    msg:'XSS Attack with Nested Base64 Detected - URL Param (Final)',\
    logdata:'Payload: %{MATCHED_VAR}',\
    severity:CRITICAL,\
    tag:'attack-xss',\
    tag:'attack-encoding-evasion',\
    tag:'paranoia-level/4',\
    tag:'OWASP_CRS/XSS/NESTED',\
    setvar:'tx.xss_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}'"

# ----------------------------------------------------------------------------
# Rule 9941006: Nested Base64 in ARGS (POST/JSON) - FINAL
# ----------------------------------------------------------------------------
SecRule ARGS "@rx (?i)(?:<\s*(?:script|iframe|object|embed|svg|details|style|math|marquee|img|body)\b|on\w+\s*=|srcdoc\s*=|formaction\s*=|javascript:|data:|vbscript:|\b(?:alert|confirm|prompt|eval|setTimeout|setInterval|Function)\s*[`(]|\((?:alert|confirm|prompt|eval)\)\s*[`(]|(?:alert|confirm|prompt|eval)\s*\.\s*(?:call|apply|bind)\s*\(|\.(?:call|apply|bind)\s*\(|[\w]*\s*=\s*(?:alert|confirm|prompt|eval)|document\s*\.\s*(?:cookie|domain|write|location)|window\s*\.\s*location|constructor\s*[`(]|__proto__)" \
    "id:9941006,\
    phase:2,\
    t:none,\
    t:base64Decode,\
    t:base64Decode,\
    t:htmlEntityDecode,\
    t:jsDecode,\
    t:removeNulls,\
    t:lowercase,\
    block,\
    msg:'XSS Attack with Nested Base64 Detected - POST/JSON (Final)',\
    logdata:'Payload: %{MATCHED_VAR}',\
    severity:CRITICAL,\
    tag:'attack-xss',\
    tag:'attack-encoding-evasion',\
    tag:'paranoia-level/4',\
    tag:'OWASP_CRS/XSS/NESTED',\
    setvar:'tx.xss_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}'"

# ============================================================================
# LAYER 3: MIXED ENCODING DETECTION - FINAL
# ============================================================================

# ----------------------------------------------------------------------------
# Rule 9941008: Mixed Encoding (URL → Base64) in ARGS_GET - FINAL
# ----------------------------------------------------------------------------
SecRule ARGS_GET "@rx (?i)(?:<\s*(?:script|iframe|object|embed|svg|details|style|math|marquee|img|body)\b|on\w+\s*=|srcdoc\s*=|formaction\s*=|javascript:|data:|vbscript:|\b(?:alert|confirm|prompt|eval|setTimeout|setInterval|Function)\s*[`(]|\((?:alert|confirm|prompt|eval)\)\s*[`(]|(?:alert|confirm|prompt|eval)\s*\.\s*(?:call|apply|bind)\s*\(|\.(?:call|apply|bind)\s*\(|[\w]*\s*=\s*(?:alert|confirm|prompt|eval)|document\s*\.\s*(?:cookie|domain|write|location)|window\s*\.\s*location|constructor\s*[`(]|__proto__)" \
    "id:9941008,\
    phase:2,\
    t:none,\
    t:urlDecodeUni,\
    t:base64Decode,\
    t:htmlEntityDecode,\
    t:jsDecode,\
    t:removeNulls,\
    t:lowercase,\
    block,\
    msg:'XSS Attack with Mixed Encoding (URL→Base64) Detected (Final)',\
    logdata:'Payload: %{MATCHED_VAR}',\
    severity:CRITICAL,\
    tag:'attack-xss',\
    tag:'attack-polyglot-encoding',\
    tag:'paranoia-level/4',\
    tag:'OWASP_CRS/XSS/MIXED',\
    setvar:'tx.xss_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}'"

# ----------------------------------------------------------------------------
# Rule 9941009: Mixed Encoding (Base64 → URL) in ARGS_GET - FINAL
# ----------------------------------------------------------------------------
SecRule ARGS_GET "@rx (?i)(?:<\s*(?:script|iframe|object|embed|svg|details|style|math|marquee|img|body)\b|on\w+\s*=|srcdoc\s*=|formaction\s*=|javascript:|data:|vbscript:|\b(?:alert|confirm|prompt|eval|setTimeout|setInterval|Function)\s*[`(]|\((?:alert|confirm|prompt|eval)\)\s*[`(]|(?:alert|confirm|prompt|eval)\s*\.\s*(?:call|apply|bind)\s*\(|\.(?:call|apply|bind)\s*\(|[\w]*\s*=\s*(?:alert|confirm|prompt|eval)|document\s*\.\s*(?:cookie|domain|write|location)|window\s*\.\s*location|constructor\s*[`(]|__proto__)" \
    "id:9941009,\
    phase:2,\
    t:none,\
    t:base64Decode,\
    t:urlDecodeUni,\
    t:htmlEntityDecode,\
    t:jsDecode,\
    t:removeNulls,\
    t:lowercase,\
    block,\
    msg:'XSS Attack with Mixed Encoding (Base64→URL) Detected (Final)',\
    logdata:'Payload: %{MATCHED_VAR}',\
    severity:CRITICAL,\
    tag:'attack-xss',\
    tag:'attack-polyglot-encoding',\
    tag:'paranoia-level/4',\
    tag:'OWASP_CRS/XSS/MIXED',\
    setvar:'tx.xss_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}'"

# ----------------------------------------------------------------------------
# Rule 9941010: Mixed Encoding in ARGS (POST/JSON) - FINAL
# ----------------------------------------------------------------------------
SecRule ARGS "@rx (?i)(?:<\s*(?:script|iframe|object|embed|svg|details|style|math|marquee|img|body)\b|on\w+\s*=|srcdoc\s*=|formaction\s*=|javascript:|data:|vbscript:|\b(?:alert|confirm|prompt|eval|setTimeout|setInterval|Function)\s*[`(]|\((?:alert|confirm|prompt|eval)\)\s*[`(]|(?:alert|confirm|prompt|eval)\s*\.\s*(?:call|apply|bind)\s*\(|\.(?:call|apply|bind)\s*\(|[\w]*\s*=\s*(?:alert|confirm|prompt|eval)|document\s*\.\s*(?:cookie|domain|write|location)|window\s*\.\s*location|constructor\s*[`(]|__proto__)" \
    "id:9941010,\
    phase:2,\
    t:none,\
    t:urlDecodeUni,\
    t:base64Decode,\
    t:htmlEntityDecode,\
    t:jsDecode,\
    t:removeNulls,\
    t:lowercase,\
    block,\
    msg:'XSS Attack with Mixed Encoding Detected - POST/JSON (Final)',\
    logdata:'Payload: %{MATCHED_VAR}',\
    severity:CRITICAL,\
    tag:'attack-xss',\
    tag:'attack-polyglot-encoding',\
    tag:'paranoia-level/4',\
    tag:'OWASP_CRS/XSS/MIXED',\
    setvar:'tx.xss_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}'"

# ============================================================================
# LAYER 4: REQUEST_URI PATH DETECTION - FINAL (WITH BASE64 DECODE)
# ============================================================================
# CRITICAL FIX: Added Base64 decode for URLPath which was bypassing

# ----------------------------------------------------------------------------
# Rule 9941011: XSS Detection in REQUEST_URI - FINAL (Base64 support)
# ----------------------------------------------------------------------------
SecRule REQUEST_URI "@rx (?i)(?:<\s*(?:script|iframe|object|embed|svg|details|style|math|marquee|img|body)\b|on\w+\s*=|javascript:|data:|\b(?:alert|confirm|prompt|eval)\s*[`(]|\((?:alert|confirm|prompt|eval)\)\s*[`(]|(?:alert|confirm|prompt|eval)\s*\.\s*(?:call|apply|bind)\s*\(|document\s*\.\s*(?:cookie|domain|write)|window\s*\.\s*location|constructor\s*[`(]|__proto__)" \
    "id:9941011,\
    phase:2,\
    t:none,\
    t:urlDecodeUni,\
    t:base64Decode,\
    t:htmlEntityDecode,\
    t:jsDecode,\
    t:removeNulls,\
    t:lowercase,\
    block,\
    msg:'XSS Attack Detected in URL Path (Final)',\
    logdata:'Path: %{REQUEST_URI}',\
    severity:CRITICAL,\
    tag:'attack-xss',\
    tag:'paranoia-level/4',\
    tag:'OWASP_CRS/XSS/FINAL',\
    setvar:'tx.xss_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}'"

# ============================================================================
# END OF FINAL GENERALIZED XSS RULES
# ============================================================================
