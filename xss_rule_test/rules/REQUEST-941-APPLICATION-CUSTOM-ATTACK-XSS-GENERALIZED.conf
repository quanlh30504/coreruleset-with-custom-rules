# ============================================================================
# OWASP CRS - Generalized XSS Detection Rules (OPTIMIZED VERSION)
# Rule ID Range: 9941000-9941020
# ============================================================================
# Purpose: OPTIMIZED hybrid XSS detection combining:
#   1. Structure-based patterns (HTML tags, events, protocols)
#   2. Function enumeration with greedy matching (like Original rules)
#   3. String concatenation detection
#   4. JS context injection detection
#   5. HTML entity bypass prevention
#
# This version aims to match/exceed Original rules (84.25%) detection rate
# while maintaining generalization benefits.
# ============================================================================

# ----------------------------------------------------------------------------
# CONFIGURATION VARIABLES
# ----------------------------------------------------------------------------
SecAction \
    "id:9941000,\
    phase:1,\
    nolog,\
    pass,\
    t:none,\
    setvar:'tx.xss_nested_decoding=1',\
    setvar:'tx.xss_max_decode_depth=2',\
    setvar:'tx.encoding_anomaly_score=3'"

# ============================================================================
# OPTIMIZED REGEX PATTERN - COMPREHENSIVE HYBRID
# ============================================================================
# Key improvements from bypass analysis:
# 1. Greedy matching with .*? for function arguments
# 2. String concatenation: ['"]\+['"]
# 3. Partial function names: (ale|ert|irm|omp|romp|val)
# 4. JS context: self\., this\., window\., parent\.
# 5. Flexible word boundary: removed strict \b where needed
# 6. Added .href= pattern for location attacks
# ============================================================================

# ============================================================================
# LAYER 1: COMPREHENSIVE XSS DETECTION - ARGS_GET
# ============================================================================

# ----------------------------------------------------------------------------
# Rule 9941002: XSS Detection in ARGS_GET (URL Parameters) - OPTIMIZED
# ----------------------------------------------------------------------------
SecRule ARGS_GET "@rx (?i)(?:<\s*(?:script|iframe|object|embed|svg|details|style|meta|link|base|img|video|audio|math|animate|set|keygen|listing|marquee|input|form|body|html|noscript|plaintext|template|slot|portal|a|area|frame|frameset|layer|bgsound|blink|ilayer|xmp|table|div|span|p|h[1-6])\b[^>]*(?:>|\/?>|\s)|on\w+\s*=|srcdoc\s*=|formaction\s*=|xlink:href\s*=|action\s*=\s*['\"]?\s*(?:javascript|data)|poster\s*=\s*['\"]?\s*javascript|background\s*=\s*['\"]?\s*javascript|href\s*=\s*['\"]?\s*(?:javascript|data|vbscript)|javascript:|data:\s*text\/html|vbscript:|view-source:|(?:alert|confirm|prompt|eval|setTimeout|setInterval|Function|atob|btoa|fetch|import|write|writeln)\s*\(.*?\)|(?:alert|confirm|prompt|eval|setTimeout|setInterval|Function)\s*`|\((?:alert|confirm|prompt|eval)\)\s*[\(`]|(?:alert|confirm|prompt|eval)\s*\.\s*(?:call|apply|bind)\s*\(|\.(?:call|apply|bind)\s*\([^)]*(?:alert|confirm|prompt|eval)|['\"][^'\"]*\+[^'\"]*['\"][^'\"]*(?:alert|confirm|prompt|eval|ert|lert|irm|ompt)|self\s*\.\s*\w+\s*=|this\s*\.\s*\w+\s*=|parent\s*\.\s*\w+|top\s*\.\s*\w+|frames\s*\[|\.href\s*=|\.location\s*=|\.innerHTML\s*=|\.outerHTML\s*=|document\s*\.\s*(?:cookie|domain|write|writeln|location|body|documentElement|innerHTML|outerHTML|URL|referrer|forms|images|links|anchors|applets|embeds|plugins|scripts|styleSheets|title|head|lastModified|readyState|activeElement|designMode|execCommand|open|close|clear|hasFocus|queryCommandEnabled|queryCommandState|queryCommandValue)|window\s*\.\s*(?:location|open|eval|name|parent|top|frames|self|opener|closed|length|history|navigator|screen|document|localStorage|sessionStorage|indexedDB|caches|crypto|performance|customElements|getComputedStyle|matchMedia|moveTo|moveBy|resizeTo|resizeBy|scroll|scrollTo|scrollBy|getSelection|find|print|stop|focus|blur|close|postMessage|addEventListener)|location\s*\.\s*(?:href|assign|replace|hash|search|pathname|protocol|host|hostname|port|origin|reload)|constructor\s*[\(`]|__proto__|prototype\s*\[|\[\s*['\"]constructor|Object\s*\.\s*(?:assign|create|defineProperty|getPrototypeOf|setPrototypeOf))" \
    "id:9941002,\
    phase:2,\
    t:none,\
    t:urlDecodeUni,\
    t:base64Decode,\
    t:htmlEntityDecode,\
    t:jsDecode,\
    t:cssDecode,\
    t:removeNulls,\
    t:compressWhitespace,\
    t:lowercase,\
    block,\
    msg:'XSS Attack Detected in URL Parameters (Optimized)',\
    logdata:'Parameter: %{MATCHED_VAR_NAME}, Payload: %{MATCHED_VAR}',\
    severity:CRITICAL,\
    tag:'attack-xss',\
    tag:'paranoia-level/4',\
    tag:'OWASP_CRS/XSS/OPTIMIZED',\
    setvar:'tx.xss_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}'"

# ============================================================================
# LAYER 2: COMPREHENSIVE XSS DETECTION - ARGS (POST/JSON)
# ============================================================================

# ----------------------------------------------------------------------------
# Rule 9941003: XSS Detection in ARGS (POST Body) - OPTIMIZED
# ----------------------------------------------------------------------------
SecRule ARGS "@rx (?i)(?:<\s*(?:script|iframe|object|embed|svg|details|style|meta|link|base|img|video|audio|math|animate|set|keygen|listing|marquee|input|form|body|html|noscript|plaintext|template|slot|portal|a|area|frame|frameset|layer|bgsound|blink|ilayer|xmp|table|div|span|p|h[1-6])\b[^>]*(?:>|\/?>|\s)|on\w+\s*=|srcdoc\s*=|formaction\s*=|xlink:href\s*=|action\s*=\s*['\"]?\s*(?:javascript|data)|poster\s*=\s*['\"]?\s*javascript|background\s*=\s*['\"]?\s*javascript|href\s*=\s*['\"]?\s*(?:javascript|data|vbscript)|javascript:|data:\s*text\/html|vbscript:|view-source:|(?:alert|confirm|prompt|eval|setTimeout|setInterval|Function|atob|btoa|fetch|import|write|writeln)\s*\(.*?\)|(?:alert|confirm|prompt|eval|setTimeout|setInterval|Function)\s*`|\((?:alert|confirm|prompt|eval)\)\s*[\(`]|(?:alert|confirm|prompt|eval)\s*\.\s*(?:call|apply|bind)\s*\(|\.(?:call|apply|bind)\s*\([^)]*(?:alert|confirm|prompt|eval)|['\"][^'\"]*\+[^'\"]*['\"][^'\"]*(?:alert|confirm|prompt|eval|ert|lert|irm|ompt)|self\s*\.\s*\w+\s*=|this\s*\.\s*\w+\s*=|parent\s*\.\s*\w+|top\s*\.\s*\w+|frames\s*\[|\.href\s*=|\.location\s*=|\.innerHTML\s*=|\.outerHTML\s*=|document\s*\.\s*(?:cookie|domain|write|writeln|location|body|documentElement|innerHTML|outerHTML|URL|referrer|forms|images|links|anchors|applets|embeds|plugins|scripts|styleSheets|title|head|lastModified|readyState|activeElement|designMode|execCommand|open|close|clear|hasFocus|queryCommandEnabled|queryCommandState|queryCommandValue)|window\s*\.\s*(?:location|open|eval|name|parent|top|frames|self|opener|closed|length|history|navigator|screen|document|localStorage|sessionStorage|indexedDB|caches|crypto|performance|customElements|getComputedStyle|matchMedia|moveTo|moveBy|resizeTo|resizeBy|scroll|scrollTo|scrollBy|getSelection|find|print|stop|focus|blur|close|postMessage|addEventListener)|location\s*\.\s*(?:href|assign|replace|hash|search|pathname|protocol|host|hostname|port|origin|reload)|constructor\s*[\(`]|__proto__|prototype\s*\[|\[\s*['\"]constructor|Object\s*\.\s*(?:assign|create|defineProperty|getPrototypeOf|setPrototypeOf))" \
    "id:9941003,\
    phase:2,\
    t:none,\
    t:urlDecodeUni,\
    t:base64Decode,\
    t:htmlEntityDecode,\
    t:jsDecode,\
    t:cssDecode,\
    t:removeNulls,\
    t:compressWhitespace,\
    t:lowercase,\
    block,\
    msg:'XSS Attack Detected in POST/JSON Data (Optimized)',\
    logdata:'Parameter: %{MATCHED_VAR_NAME}, Payload: %{MATCHED_VAR}',\
    severity:CRITICAL,\
    tag:'attack-xss',\
    tag:'paranoia-level/4',\
    tag:'OWASP_CRS/XSS/OPTIMIZED',\
    setvar:'tx.xss_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}'"

# ============================================================================
# LAYER 3: COMPREHENSIVE XSS DETECTION - REQUEST_HEADERS
# ============================================================================

# ----------------------------------------------------------------------------
# Rule 9941004: XSS Detection in REQUEST_HEADERS - OPTIMIZED
# ----------------------------------------------------------------------------
SecRule REQUEST_HEADERS "@rx (?i)(?:<\s*(?:script|iframe|object|embed|svg|details|style|meta|link|base|img|video|audio|math|animate|input|form|body|html|noscript)\b[^>]*(?:>|\/?>|\s)|on\w+\s*=|srcdoc\s*=|formaction\s*=|xlink:href\s*=|javascript:|data:\s*text\/html|vbscript:|(?:alert|confirm|prompt|eval|setTimeout|setInterval|Function)\s*\(.*?\)|(?:alert|confirm|prompt|eval)\s*`|\((?:alert|confirm|prompt|eval)\)\s*[\(`]|(?:alert|confirm|prompt|eval)\s*\.\s*(?:call|apply|bind)\s*\(|\.(?:call|apply|bind)\s*\(|['\"][^'\"]*\+[^'\"]*['\"]|self\s*\.\s*\w+\s*=|document\s*\.\s*(?:cookie|domain|write|location)|window\s*\.\s*(?:location|open|eval)|location\s*\.\s*(?:href|assign|replace)|constructor\s*[\(`]|__proto__)" \
    "id:9941004,\
    phase:2,\
    t:none,\
    t:urlDecodeUni,\
    t:base64Decode,\
    t:htmlEntityDecode,\
    t:jsDecode,\
    t:cssDecode,\
    t:removeNulls,\
    t:compressWhitespace,\
    t:lowercase,\
    block,\
    msg:'XSS Attack Detected in HTTP Headers (Optimized)',\
    logdata:'Header: %{MATCHED_VAR_NAME}, Payload: %{MATCHED_VAR}',\
    severity:CRITICAL,\
    tag:'attack-xss',\
    tag:'paranoia-level/4',\
    tag:'OWASP_CRS/XSS/OPTIMIZED',\
    setvar:'tx.xss_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}'"

# ============================================================================
# LAYER 4: NESTED BASE64 DETECTION - OPTIMIZED
# ============================================================================

# ----------------------------------------------------------------------------
# Rule 9941005: Nested Base64 in ARGS_GET - OPTIMIZED
# ----------------------------------------------------------------------------
SecRule ARGS_GET "@rx (?i)(?:<\s*(?:script|iframe|object|embed|svg|details|style|math|marquee|img|body|input|form)\b|on\w+\s*=|srcdoc\s*=|formaction\s*=|javascript:|data:\s*text\/html|vbscript:|(?:alert|confirm|prompt|eval|setTimeout|setInterval|Function)\s*\(.*?\)|(?:alert|confirm|prompt|eval)\s*`|\((?:alert|confirm|prompt|eval)\)\s*[\(`]|(?:alert|confirm|prompt|eval)\s*\.\s*(?:call|apply|bind)\s*\(|\.(?:call|apply|bind)\s*\(|['\"][^'\"]*\+[^'\"]*['\"]|self\s*\.\s*\w+\s*=|document\s*\.\s*(?:cookie|domain|write|location)|window\s*\.\s*location|constructor\s*[\(`]|__proto__)" \
    "id:9941005,\
    phase:2,\
    t:none,\
    t:base64Decode,\
    t:base64Decode,\
    t:htmlEntityDecode,\
    t:jsDecode,\
    t:removeNulls,\
    t:compressWhitespace,\
    t:lowercase,\
    block,\
    msg:'XSS Attack with Nested Base64 Detected - URL Param (Optimized)',\
    logdata:'Payload: %{MATCHED_VAR}',\
    severity:CRITICAL,\
    tag:'attack-xss',\
    tag:'attack-encoding-evasion',\
    tag:'paranoia-level/4',\
    tag:'OWASP_CRS/XSS/NESTED',\
    setvar:'tx.xss_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}'"

# ----------------------------------------------------------------------------
# Rule 9941006: Nested Base64 in ARGS (POST/JSON) - OPTIMIZED
# ----------------------------------------------------------------------------
SecRule ARGS "@rx (?i)(?:<\s*(?:script|iframe|object|embed|svg|details|style|math|marquee|img|body|input|form)\b|on\w+\s*=|srcdoc\s*=|formaction\s*=|javascript:|data:\s*text\/html|vbscript:|(?:alert|confirm|prompt|eval|setTimeout|setInterval|Function)\s*\(.*?\)|(?:alert|confirm|prompt|eval)\s*`|\((?:alert|confirm|prompt|eval)\)\s*[\(`]|(?:alert|confirm|prompt|eval)\s*\.\s*(?:call|apply|bind)\s*\(|\.(?:call|apply|bind)\s*\(|['\"][^'\"]*\+[^'\"]*['\"]|self\s*\.\s*\w+\s*=|document\s*\.\s*(?:cookie|domain|write|location)|window\s*\.\s*location|constructor\s*[\(`]|__proto__)" \
    "id:9941006,\
    phase:2,\
    t:none,\
    t:base64Decode,\
    t:base64Decode,\
    t:htmlEntityDecode,\
    t:jsDecode,\
    t:removeNulls,\
    t:compressWhitespace,\
    t:lowercase,\
    block,\
    msg:'XSS Attack with Nested Base64 Detected - POST/JSON (Optimized)',\
    logdata:'Payload: %{MATCHED_VAR}',\
    severity:CRITICAL,\
    tag:'attack-xss',\
    tag:'attack-encoding-evasion',\
    tag:'paranoia-level/4',\
    tag:'OWASP_CRS/XSS/NESTED',\
    setvar:'tx.xss_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}'"

# ============================================================================
# LAYER 5: MIXED ENCODING DETECTION - OPTIMIZED
# ============================================================================

# ----------------------------------------------------------------------------
# Rule 9941008: Mixed Encoding (URL → Base64) - OPTIMIZED
# ----------------------------------------------------------------------------
SecRule ARGS_GET "@rx (?i)(?:<\s*(?:script|iframe|object|embed|svg|details|style|math|marquee|img|body)\b|on\w+\s*=|javascript:|data:\s*text\/html|vbscript:|(?:alert|confirm|prompt|eval|setTimeout|setInterval|Function)\s*\(.*?\)|(?:alert|confirm|prompt|eval)\s*`|\((?:alert|confirm|prompt|eval)\)\s*[\(`]|(?:alert|confirm|prompt|eval)\s*\.\s*(?:call|apply|bind)\s*\(|\.(?:call|apply|bind)\s*\(|['\"][^'\"]*\+[^'\"]*['\"]|self\s*\.\s*\w+\s*=|document\s*\.\s*(?:cookie|domain|write|location)|window\s*\.\s*location|constructor\s*[\(`]|__proto__)" \
    "id:9941008,\
    phase:2,\
    t:none,\
    t:urlDecodeUni,\
    t:base64Decode,\
    t:htmlEntityDecode,\
    t:jsDecode,\
    t:removeNulls,\
    t:compressWhitespace,\
    t:lowercase,\
    block,\
    msg:'XSS Attack with Mixed Encoding (URL→Base64) Detected (Optimized)',\
    logdata:'Payload: %{MATCHED_VAR}',\
    severity:CRITICAL,\
    tag:'attack-xss',\
    tag:'attack-polyglot-encoding',\
    tag:'paranoia-level/4',\
    tag:'OWASP_CRS/XSS/MIXED',\
    setvar:'tx.xss_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}'"

# ----------------------------------------------------------------------------
# Rule 9941009: Mixed Encoding (Base64 → URL) - OPTIMIZED
# ----------------------------------------------------------------------------
SecRule ARGS_GET "@rx (?i)(?:<\s*(?:script|iframe|object|embed|svg|details|style|math|marquee|img|body)\b|on\w+\s*=|javascript:|data:\s*text\/html|vbscript:|(?:alert|confirm|prompt|eval|setTimeout|setInterval|Function)\s*\(.*?\)|(?:alert|confirm|prompt|eval)\s*`|\((?:alert|confirm|prompt|eval)\)\s*[\(`]|(?:alert|confirm|prompt|eval)\s*\.\s*(?:call|apply|bind)\s*\(|\.(?:call|apply|bind)\s*\(|['\"][^'\"]*\+[^'\"]*['\"]|self\s*\.\s*\w+\s*=|document\s*\.\s*(?:cookie|domain|write|location)|window\s*\.\s*location|constructor\s*[\(`]|__proto__)" \
    "id:9941009,\
    phase:2,\
    t:none,\
    t:base64Decode,\
    t:urlDecodeUni,\
    t:htmlEntityDecode,\
    t:jsDecode,\
    t:removeNulls,\
    t:compressWhitespace,\
    t:lowercase,\
    block,\
    msg:'XSS Attack with Mixed Encoding (Base64→URL) Detected (Optimized)',\
    logdata:'Payload: %{MATCHED_VAR}',\
    severity:CRITICAL,\
    tag:'attack-xss',\
    tag:'attack-polyglot-encoding',\
    tag:'paranoia-level/4',\
    tag:'OWASP_CRS/XSS/MIXED',\
    setvar:'tx.xss_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}'"

# ----------------------------------------------------------------------------
# Rule 9941010: Mixed Encoding in ARGS (POST/JSON) - OPTIMIZED
# ----------------------------------------------------------------------------
SecRule ARGS "@rx (?i)(?:<\s*(?:script|iframe|object|embed|svg|details|style|math|marquee|img|body)\b|on\w+\s*=|javascript:|data:\s*text\/html|vbscript:|(?:alert|confirm|prompt|eval|setTimeout|setInterval|Function)\s*\(.*?\)|(?:alert|confirm|prompt|eval)\s*`|\((?:alert|confirm|prompt|eval)\)\s*[\(`]|(?:alert|confirm|prompt|eval)\s*\.\s*(?:call|apply|bind)\s*\(|\.(?:call|apply|bind)\s*\(|['\"][^'\"]*\+[^'\"]*['\"]|self\s*\.\s*\w+\s*=|document\s*\.\s*(?:cookie|domain|write|location)|window\s*\.\s*location|constructor\s*[\(`]|__proto__)" \
    "id:9941010,\
    phase:2,\
    t:none,\
    t:urlDecodeUni,\
    t:base64Decode,\
    t:htmlEntityDecode,\
    t:jsDecode,\
    t:removeNulls,\
    t:compressWhitespace,\
    t:lowercase,\
    block,\
    msg:'XSS Attack with Mixed Encoding Detected - POST/JSON (Optimized)',\
    logdata:'Payload: %{MATCHED_VAR}',\
    severity:CRITICAL,\
    tag:'attack-xss',\
    tag:'attack-polyglot-encoding',\
    tag:'paranoia-level/4',\
    tag:'OWASP_CRS/XSS/MIXED',\
    setvar:'tx.xss_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}'"

# ============================================================================
# LAYER 6: REQUEST_URI PATH DETECTION - OPTIMIZED (WITH FULL DECODING)
# ============================================================================

# ----------------------------------------------------------------------------
# Rule 9941011: XSS Detection in REQUEST_URI - OPTIMIZED (Base64 + Full decode)
# ----------------------------------------------------------------------------
SecRule REQUEST_URI "@rx (?i)(?:<\s*(?:script|iframe|object|embed|svg|details|style|math|marquee|img|body|input|form)\b|on\w+\s*=|javascript:|data:\s*text\/html|(?:alert|confirm|prompt|eval|setTimeout|setInterval|Function)\s*\(.*?\)|(?:alert|confirm|prompt|eval)\s*`|\((?:alert|confirm|prompt|eval)\)\s*[\(`]|(?:alert|confirm|prompt|eval)\s*\.\s*(?:call|apply|bind)\s*\(|\.(?:call|apply|bind)\s*\(|['\"][^'\"]*\+[^'\"]*['\"]|self\s*\.\s*\w+\s*=|document\s*\.\s*(?:cookie|domain|write)|window\s*\.\s*location|constructor\s*[\(`]|__proto__)" \
    "id:9941011,\
    phase:2,\
    t:none,\
    t:urlDecodeUni,\
    t:base64Decode,\
    t:htmlEntityDecode,\
    t:jsDecode,\
    t:removeNulls,\
    t:compressWhitespace,\
    t:lowercase,\
    block,\
    msg:'XSS Attack Detected in URL Path (Optimized)',\
    logdata:'Path: %{REQUEST_URI}',\
    severity:CRITICAL,\
    tag:'attack-xss',\
    tag:'paranoia-level/4',\
    tag:'OWASP_CRS/XSS/OPTIMIZED',\
    setvar:'tx.xss_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}'"

# ============================================================================
# LAYER 7: SPECIAL BYPASS DETECTION - NEW PATTERNS FROM ANALYSIS
# ============================================================================

# ----------------------------------------------------------------------------
# Rule 9941012: String Concatenation XSS Detection - CRITICAL FIX
# Catches: javascript:setInterval('ale'+'rt(document.domain)')
# ----------------------------------------------------------------------------
SecRule ARGS|ARGS_GET|REQUEST_URI "@rx (?i)(?:['\"][^'\"]*\+[^'\"]*['\"][^'\"]*(?:alert|confirm|prompt|eval|ert\(|lert\(|irm\(|ompt\()|setInterval\s*\([^)]*\+|setTimeout\s*\([^)]*\+|Function\s*\([^)]*\+)" \
    "id:9941012,\
    phase:2,\
    t:none,\
    t:urlDecodeUni,\
    t:base64Decode,\
    t:htmlEntityDecode,\
    t:jsDecode,\
    t:removeNulls,\
    t:compressWhitespace,\
    t:lowercase,\
    block,\
    msg:'XSS String Concatenation Attack Detected (Optimized)',\
    logdata:'Payload: %{MATCHED_VAR}',\
    severity:CRITICAL,\
    tag:'attack-xss',\
    tag:'attack-string-concat',\
    tag:'paranoia-level/4',\
    tag:'OWASP_CRS/XSS/STRING_CONCAT',\
    setvar:'tx.xss_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}'"

# ----------------------------------------------------------------------------
# Rule 9941013: JS Context Injection Detection
# Catches: "));if(!self.x)self.x=!alert(document.domain)}catch(e){}//
# ----------------------------------------------------------------------------
SecRule ARGS|ARGS_GET|REQUEST_URI "@rx (?i)(?:self\s*\.\s*\w+\s*=\s*!?\s*(?:alert|confirm|prompt|eval)|catch\s*\([^)]*\)\s*\{[^}]*\}|try\s*\{[^}]*(?:alert|confirm|prompt|eval)|}\s*catch\s*\(|}\s*finally\s*\{|throw\s+\d+|=\s*!(?:alert|confirm|prompt|eval))" \
    "id:9941013,\
    phase:2,\
    t:none,\
    t:urlDecodeUni,\
    t:base64Decode,\
    t:htmlEntityDecode,\
    t:jsDecode,\
    t:removeNulls,\
    t:compressWhitespace,\
    t:lowercase,\
    block,\
    msg:'XSS JS Context Injection Detected (Optimized)',\
    logdata:'Payload: %{MATCHED_VAR}',\
    severity:CRITICAL,\
    tag:'attack-xss',\
    tag:'attack-js-context',\
    tag:'paranoia-level/4',\
    tag:'OWASP_CRS/XSS/JS_CONTEXT',\
    setvar:'tx.xss_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}'"

# ----------------------------------------------------------------------------
# Rule 9941014: HTML Entity XSS Detection (Pre-decoded check)
# Catches: <IMG SRC=j&#X41vascript:alert('test')>
# Note: Runs BEFORE htmlEntityDecode to catch raw entity patterns
# ----------------------------------------------------------------------------
SecRule ARGS|ARGS_GET|REQUEST_URI "@rx (?i)(?:&\#[xX]?[0-9a-fA-F]+;?\s*(?:a|j|v|s|c|r|i|p|t)|&(?:lt|gt|amp|quot|apos);?\s*(?:script|svg|img|body|iframe|on\w+|javascript|alert|confirm|prompt))" \
    "id:9941014,\
    phase:2,\
    t:none,\
    t:urlDecodeUni,\
    t:base64Decode,\
    t:removeNulls,\
    t:compressWhitespace,\
    t:lowercase,\
    block,\
    msg:'XSS HTML Entity Obfuscation Detected (Optimized)',\
    logdata:'Payload: %{MATCHED_VAR}',\
    severity:CRITICAL,\
    tag:'attack-xss',\
    tag:'attack-html-entity',\
    tag:'paranoia-level/4',\
    tag:'OWASP_CRS/XSS/HTML_ENTITY',\
    setvar:'tx.xss_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}'"

# ----------------------------------------------------------------------------
# Rule 9941015: DOM Sink Injection Detection
# Catches: window.location.href=, .innerHTML=, document.write(
# ----------------------------------------------------------------------------
SecRule ARGS|ARGS_GET|REQUEST_URI "@rx (?i)(?:\.(?:href|src|action|data|innerHTML|outerHTML|innerText|outerText|textContent|value)\s*=\s*['\"]?(?:javascript|data|vbscript|\/\/)|document\s*\.\s*(?:write|writeln)\s*\(|\.(?:insertAdjacentHTML|insertBefore|appendChild|replaceChild|cloneNode)\s*\(|eval\s*\(\s*(?:unescape|decodeURI|atob)\s*\(|new\s+Function\s*\()" \
    "id:9941015,\
    phase:2,\
    t:none,\
    t:urlDecodeUni,\
    t:base64Decode,\
    t:htmlEntityDecode,\
    t:jsDecode,\
    t:removeNulls,\
    t:compressWhitespace,\
    t:lowercase,\
    block,\
    msg:'XSS DOM Sink Injection Detected (Optimized)',\
    logdata:'Payload: %{MATCHED_VAR}',\
    severity:CRITICAL,\
    tag:'attack-xss',\
    tag:'attack-dom-sink',\
    tag:'paranoia-level/4',\
    tag:'OWASP_CRS/XSS/DOM_SINK',\
    setvar:'tx.xss_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}'"

# ============================================================================
# END OF OPTIMIZED GENERALIZED XSS RULES
# ============================================================================
