# ============================================================================
# OWASP CRS - Generalized XSS Detection Rules (OPTIMIZED VERSION)
# Rule ID Range: 9941000-9941020
# ============================================================================
# Purpose: OPTIMIZED hybrid XSS detection combining:
#   1. Structure-based patterns (HTML tags, events, protocols)
#   2. Function enumeration with greedy matching (like Original rules)
#   3. String concatenation detection
#   4. JS context injection detection
#   5. HTML entity bypass prevention
#
# This version aims to match/exceed Original rules (84.25%) detection rate
# while maintaining generalization benefits.
# ============================================================================

# ----------------------------------------------------------------------------
# CONFIGURATION VARIABLES
# ----------------------------------------------------------------------------
SecAction \
    "id:9941000,\
    phase:1,\
    nolog,\
    pass,\
    t:none,\
    setvar:'tx.xss_nested_decoding=1',\
    setvar:'tx.xss_max_decode_depth=2',\
    setvar:'tx.encoding_anomaly_score=3'"

# ============================================================================
# OPTIMIZED REGEX PATTERN - COMPREHENSIVE HYBRID
# ============================================================================
# Key improvements from bypass analysis:
# 1. Greedy matching with .*? for function arguments
# 2. String concatenation: ['"]\+['"]
# 3. Partial function names: (ale|ert|irm|omp|romp|val)
# 4. JS context: self\., this\., window\., parent\.
# 5. Flexible word boundary: removed strict \b where needed
# 6. Added .href= pattern for location attacks
# ============================================================================

# ============================================================================
# LAYER 0: URL PATH CAPTURE AND DECODE (CRITICAL FOR BASE64 URLPATH)
# ============================================================================
# This layer captures URL path segment and decodes it before XSS detection
# Similar approach to Original rules but with enhanced patterns

# ----------------------------------------------------------------------------
# Rule 9941001: Capture URL Path Segment for Processing
# Captures: /PGJvZHkgb25sb2FkPWFsZXJ0KCd0ZXN0MScpPg -> tx.xss_urlpath_raw
# ----------------------------------------------------------------------------
SecRule REQUEST_URI "@rx ^.*/([^/]+)$" \
    "id:9941001,\
    phase:2,\
    log,\
    auditlog,\
    pass,\
    capture,\
    t:none,\
    setvar:'tx.xss_urlpath_raw=%{TX.1}',\
    msg:'XSS: Captured URL path value: %{TX.xss_urlpath_raw}'"

# ----------------------------------------------------------------------------
# Rule 9941050: Decode URL Path Value (Base64 + HTML Entity)
# Decodes captured URL path for XSS pattern matching
# ----------------------------------------------------------------------------
SecRule TX:xss_urlpath_raw "@rx .+" \
    "id:9941050,\
    phase:2,\
    log,\
    auditlog,\
    pass,\
    capture,\
    t:none,\
    t:base64Decode,\
    t:urlDecodeUni,\
    t:htmlEntityDecode,\
    t:jsDecode,\
    t:removeNulls,\
    setvar:'tx.xss_urlpath_decoded=%{MATCHED_VAR}',\
    msg:'XSS: Decoded URL path value: %{TX.xss_urlpath_decoded}'"

# ----------------------------------------------------------------------------
# Rule 9941051: XSS Detection in Decoded URL Path (CRITICAL)
# Uses comprehensive XSS patterns against both raw and decoded path values
# ----------------------------------------------------------------------------
SecRule TX:xss_urlpath_raw|TX:xss_urlpath_decoded "@rx (?i)(?:<\s*(?:script|iframe|object|embed|svg|details|style|meta|link|base|img|video|audio|math|animate|set|keygen|listing|marquee|input|form|body|html|noscript)\b[^>]*(?:>|/?>|\s)|on\w+\s*=|srcdoc\s*=|formaction\s*=|xlink:href\s*=|javascript:|data:\s*text/html|vbscript:|(?:alert|confirm|prompt|eval|setTimeout|setInterval|Function)\s*\(.*?\)|(?:alert|confirm|prompt|eval)\s*\x60|\(\s*(?:alert|confirm|prompt|eval)\s*\)\s*[\(\x60]|(?:alert|confirm|prompt|eval)\s*\.\s*(?:call|apply|bind)\s*\(|call\s*\(\s*(?:null|this|window)|apply\s*\(\s*(?:null|this|window)|['\"][^'\"]*\+[^'\"]*['\"]|self\s*\.\s*\w+\s*=|document\s*\.\s*(?:cookie|domain|write|location)|window\s*\.\s*(?:location|open|eval)|location\s*\.\s*(?:href|assign|replace)|constructor\s*[\(\x60]|__proto__|prototype\s*\[)" \
    "id:9941051,\
    phase:2,\
    t:none,\
    t:lowercase,\
    block,\
    msg:'XSS Attack Detected in URL Path (Decoded)',\
    logdata:'Raw: %{TX.xss_urlpath_raw}, Decoded: %{TX.xss_urlpath_decoded}',\
    severity:CRITICAL,\
    tag:'attack-xss',\
    tag:'attack-urlpath',\
    tag:'paranoia-level/4',\
    tag:'OWASP_CRS/XSS/URLPATH',\
    setvar:'tx.xss_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}'"



# ============================================================================
# LAYER 1: COMPREHENSIVE XSS DETECTION - ARGS_GET
# ============================================================================

# ----------------------------------------------------------------------------
# Rule 9941002: XSS Detection in ARGS_GET (URL Parameters) - OPTIMIZED
# ----------------------------------------------------------------------------
SecRule ARGS_GET "@rx (?i)(?:<\s*(?:script|iframe|object|embed|svg|details|style|meta|link|base|img|video|audio|math|animate|set|keygen|listing|marquee|input|form|body|html|noscript|plaintext|template|slot|portal|a|area|frame|frameset|layer|bgsound|blink|ilayer|xmp|table|div|span|p|h[1-6])\b[^>]*(?:>|\/?>|\s)|on\w+\s*=|srcdoc\s*=|formaction\s*=|xlink:href\s*=|action\s*=\s*['\"]?\s*(?:javascript|data)|poster\s*=\s*['\"]?\s*javascript|background\s*=\s*['\"]?\s*javascript|href\s*=\s*['\"]?\s*(?:javascript|data|vbscript)|javascript:|data:\s*text\/html|vbscript:|view-source:|(?:alert|confirm|prompt|eval|setTimeout|setInterval|Function|atob|btoa|fetch|import|write|writeln)\s*\(.*?\)|(?:alert|confirm|prompt|eval|setTimeout|setInterval|Function)\s*`|\((?:alert|confirm|prompt|eval)\)\s*[\(`]|(?:alert|confirm|prompt|eval)\s*\.\s*(?:call|apply|bind)\s*\(|\.(?:call|apply|bind)\s*\([^)]*(?:alert|confirm|prompt|eval)|['\"][^'\"]*\+[^'\"]*['\"][^'\"]*(?:alert|confirm|prompt|eval|ert|lert|irm|ompt)|self\s*\.\s*\w+\s*=|this\s*\.\s*\w+\s*=|parent\s*\.\s*\w+|top\s*\.\s*\w+|frames\s*\[|\.href\s*=|\.location\s*=|\.innerHTML\s*=|\.outerHTML\s*=|document\s*\.\s*(?:cookie|domain|write|writeln|location|body|documentElement|innerHTML|outerHTML|URL|referrer|forms|images|links|anchors|applets|embeds|plugins|scripts|styleSheets|title|head|lastModified|readyState|activeElement|designMode|execCommand|open|close|clear|hasFocus|queryCommandEnabled|queryCommandState|queryCommandValue)|window\s*\.\s*(?:location|open|eval|name|parent|top|frames|self|opener|closed|length|history|navigator|screen|document|localStorage|sessionStorage|indexedDB|caches|crypto|performance|customElements|getComputedStyle|matchMedia|moveTo|moveBy|resizeTo|resizeBy|scroll|scrollTo|scrollBy|getSelection|find|print|stop|focus|blur|close|postMessage|addEventListener)|location\s*\.\s*(?:href|assign|replace|hash|search|pathname|protocol|host|hostname|port|origin|reload)|constructor\s*[\(`]|__proto__|prototype\s*\[|\[\s*['\"]constructor|Object\s*\.\s*(?:assign|create|defineProperty|getPrototypeOf|setPrototypeOf))" \
    "id:9941002,\
    phase:2,\
    t:none,\
    t:urlDecodeUni,\
    t:base64Decode,\
    t:htmlEntityDecode,\
    t:jsDecode,\
    t:cssDecode,\
    t:removeNulls,\
    t:compressWhitespace,\
    t:lowercase,\
    block,\
    msg:'XSS Attack Detected in URL Parameters (Optimized)',\
    logdata:'Parameter: %{MATCHED_VAR_NAME}, Payload: %{MATCHED_VAR}',\
    severity:CRITICAL,\
    tag:'attack-xss',\
    tag:'paranoia-level/4',\
    tag:'OWASP_CRS/XSS/OPTIMIZED',\
    setvar:'tx.xss_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}'"

# ============================================================================
# LAYER 2: COMPREHENSIVE XSS DETECTION - ARGS (POST/JSON)
# ============================================================================

# ----------------------------------------------------------------------------
# Rule 9941003: XSS Detection in ARGS (POST Body) - OPTIMIZED
# ----------------------------------------------------------------------------
SecRule ARGS "@rx (?i)(?:<\s*(?:script|iframe|object|embed|svg|details|style|meta|link|base|img|video|audio|math|animate|set|keygen|listing|marquee|input|form|body|html|noscript|plaintext|template|slot|portal|a|area|frame|frameset|layer|bgsound|blink|ilayer|xmp|table|div|span|p|h[1-6])\b[^>]*(?:>|\/?>|\s)|on\w+\s*=|srcdoc\s*=|formaction\s*=|xlink:href\s*=|action\s*=\s*['\"]?\s*(?:javascript|data)|poster\s*=\s*['\"]?\s*javascript|background\s*=\s*['\"]?\s*javascript|href\s*=\s*['\"]?\s*(?:javascript|data|vbscript)|javascript:|data:\s*text\/html|vbscript:|view-source:|(?:alert|confirm|prompt|eval|setTimeout|setInterval|Function|atob|btoa|fetch|import|write|writeln)\s*\(.*?\)|(?:alert|confirm|prompt|eval|setTimeout|setInterval|Function)\s*`|\((?:alert|confirm|prompt|eval)\)\s*[\(`]|(?:alert|confirm|prompt|eval)\s*\.\s*(?:call|apply|bind)\s*\(|\.(?:call|apply|bind)\s*\([^)]*(?:alert|confirm|prompt|eval)|['\"][^'\"]*\+[^'\"]*['\"][^'\"]*(?:alert|confirm|prompt|eval|ert|lert|irm|ompt)|self\s*\.\s*\w+\s*=|this\s*\.\s*\w+\s*=|parent\s*\.\s*\w+|top\s*\.\s*\w+|frames\s*\[|\.href\s*=|\.location\s*=|\.innerHTML\s*=|\.outerHTML\s*=|document\s*\.\s*(?:cookie|domain|write|writeln|location|body|documentElement|innerHTML|outerHTML|URL|referrer|forms|images|links|anchors|applets|embeds|plugins|scripts|styleSheets|title|head|lastModified|readyState|activeElement|designMode|execCommand|open|close|clear|hasFocus|queryCommandEnabled|queryCommandState|queryCommandValue)|window\s*\.\s*(?:location|open|eval|name|parent|top|frames|self|opener|closed|length|history|navigator|screen|document|localStorage|sessionStorage|indexedDB|caches|crypto|performance|customElements|getComputedStyle|matchMedia|moveTo|moveBy|resizeTo|resizeBy|scroll|scrollTo|scrollBy|getSelection|find|print|stop|focus|blur|close|postMessage|addEventListener)|location\s*\.\s*(?:href|assign|replace|hash|search|pathname|protocol|host|hostname|port|origin|reload)|constructor\s*[\(`]|__proto__|prototype\s*\[|\[\s*['\"]constructor|Object\s*\.\s*(?:assign|create|defineProperty|getPrototypeOf|setPrototypeOf))" \
    "id:9941003,\
    phase:2,\
    t:none,\
    t:urlDecodeUni,\
    t:base64Decode,\
    t:htmlEntityDecode,\
    t:jsDecode,\
    t:cssDecode,\
    t:removeNulls,\
    t:compressWhitespace,\
    t:lowercase,\
    block,\
    msg:'XSS Attack Detected in POST/JSON Data (Optimized)',\
    logdata:'Parameter: %{MATCHED_VAR_NAME}, Payload: %{MATCHED_VAR}',\
    severity:CRITICAL,\
    tag:'attack-xss',\
    tag:'paranoia-level/4',\
    tag:'OWASP_CRS/XSS/OPTIMIZED',\
    setvar:'tx.xss_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}'"

# ============================================================================
# LAYER 3: COMPREHENSIVE XSS DETECTION - REQUEST_HEADERS
# ============================================================================

# ----------------------------------------------------------------------------
# Rule 9941004: XSS Detection in REQUEST_HEADERS - OPTIMIZED
# ----------------------------------------------------------------------------
SecRule REQUEST_HEADERS "@rx (?i)(?:<\s*(?:script|iframe|object|embed|svg|details|style|meta|link|base|img|video|audio|math|animate|input|form|body|html|noscript)\b[^>]*(?:>|\/?>|\s)|on\w+\s*=|srcdoc\s*=|formaction\s*=|xlink:href\s*=|javascript:|data:\s*text\/html|vbscript:|(?:alert|confirm|prompt|eval|setTimeout|setInterval|Function)\s*\(.*?\)|(?:alert|confirm|prompt|eval)\s*`|\((?:alert|confirm|prompt|eval)\)\s*[\(`]|(?:alert|confirm|prompt|eval)\s*\.\s*(?:call|apply|bind)\s*\(|\.(?:call|apply|bind)\s*\(|['\"][^'\"]*\+[^'\"]*['\"]|self\s*\.\s*\w+\s*=|document\s*\.\s*(?:cookie|domain|write|location)|window\s*\.\s*(?:location|open|eval)|location\s*\.\s*(?:href|assign|replace)|constructor\s*[\(`]|__proto__)" \
    "id:9941004,\
    phase:2,\
    t:none,\
    t:urlDecodeUni,\
    t:base64Decode,\
    t:htmlEntityDecode,\
    t:jsDecode,\
    t:cssDecode,\
    t:removeNulls,\
    t:compressWhitespace,\
    t:lowercase,\
    block,\
    msg:'XSS Attack Detected in HTTP Headers (Optimized)',\
    logdata:'Header: %{MATCHED_VAR_NAME}, Payload: %{MATCHED_VAR}',\
    severity:CRITICAL,\
    tag:'attack-xss',\
    tag:'paranoia-level/4',\
    tag:'OWASP_CRS/XSS/OPTIMIZED',\
    setvar:'tx.xss_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}'"

# ============================================================================
# LAYER 4: NESTED BASE64 DETECTION - OPTIMIZED
# ============================================================================

# ----------------------------------------------------------------------------
# Rule 9941005: Nested Base64 in ARGS_GET - OPTIMIZED
# ----------------------------------------------------------------------------
SecRule ARGS_GET "@rx (?i)(?:<\s*(?:script|iframe|object|embed|svg|details|style|math|marquee|img|body|input|form)\b|on\w+\s*=|srcdoc\s*=|formaction\s*=|javascript:|data:\s*text\/html|vbscript:|(?:alert|confirm|prompt|eval|setTimeout|setInterval|Function)\s*\(.*?\)|(?:alert|confirm|prompt|eval)\s*`|\((?:alert|confirm|prompt|eval)\)\s*[\(`]|(?:alert|confirm|prompt|eval)\s*\.\s*(?:call|apply|bind)\s*\(|\.(?:call|apply|bind)\s*\(|['\"][^'\"]*\+[^'\"]*['\"]|self\s*\.\s*\w+\s*=|document\s*\.\s*(?:cookie|domain|write|location)|window\s*\.\s*location|constructor\s*[\(`]|__proto__)" \
    "id:9941005,\
    phase:2,\
    t:none,\
    t:base64Decode,\
    t:base64Decode,\
    t:htmlEntityDecode,\
    t:jsDecode,\
    t:removeNulls,\
    t:compressWhitespace,\
    t:lowercase,\
    block,\
    msg:'XSS Attack with Nested Base64 Detected - URL Param (Optimized)',\
    logdata:'Payload: %{MATCHED_VAR}',\
    severity:CRITICAL,\
    tag:'attack-xss',\
    tag:'attack-encoding-evasion',\
    tag:'paranoia-level/4',\
    tag:'OWASP_CRS/XSS/NESTED',\
    setvar:'tx.xss_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}'"

# ----------------------------------------------------------------------------
# Rule 9941006: Nested Base64 in ARGS (POST/JSON) - OPTIMIZED
# ----------------------------------------------------------------------------
SecRule ARGS "@rx (?i)(?:<\s*(?:script|iframe|object|embed|svg|details|style|math|marquee|img|body|input|form)\b|on\w+\s*=|srcdoc\s*=|formaction\s*=|javascript:|data:\s*text\/html|vbscript:|(?:alert|confirm|prompt|eval|setTimeout|setInterval|Function)\s*\(.*?\)|(?:alert|confirm|prompt|eval)\s*`|\((?:alert|confirm|prompt|eval)\)\s*[\(`]|(?:alert|confirm|prompt|eval)\s*\.\s*(?:call|apply|bind)\s*\(|\.(?:call|apply|bind)\s*\(|['\"][^'\"]*\+[^'\"]*['\"]|self\s*\.\s*\w+\s*=|document\s*\.\s*(?:cookie|domain|write|location)|window\s*\.\s*location|constructor\s*[\(`]|__proto__)" \
    "id:9941006,\
    phase:2,\
    t:none,\
    t:base64Decode,\
    t:base64Decode,\
    t:htmlEntityDecode,\
    t:jsDecode,\
    t:removeNulls,\
    t:compressWhitespace,\
    t:lowercase,\
    block,\
    msg:'XSS Attack with Nested Base64 Detected - POST/JSON (Optimized)',\
    logdata:'Payload: %{MATCHED_VAR}',\
    severity:CRITICAL,\
    tag:'attack-xss',\
    tag:'attack-encoding-evasion',\
    tag:'paranoia-level/4',\
    tag:'OWASP_CRS/XSS/NESTED',\
    setvar:'tx.xss_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}'"

# ============================================================================
# LAYER 5: MIXED ENCODING DETECTION - OPTIMIZED
# ============================================================================

# ----------------------------------------------------------------------------
# Rule 9941008: Mixed Encoding (URL → Base64) - OPTIMIZED
# ----------------------------------------------------------------------------
SecRule ARGS_GET "@rx (?i)(?:<\s*(?:script|iframe|object|embed|svg|details|style|math|marquee|img|body)\b|on\w+\s*=|javascript:|data:\s*text\/html|vbscript:|(?:alert|confirm|prompt|eval|setTimeout|setInterval|Function)\s*\(.*?\)|(?:alert|confirm|prompt|eval)\s*`|\((?:alert|confirm|prompt|eval)\)\s*[\(`]|(?:alert|confirm|prompt|eval)\s*\.\s*(?:call|apply|bind)\s*\(|\.(?:call|apply|bind)\s*\(|['\"][^'\"]*\+[^'\"]*['\"]|self\s*\.\s*\w+\s*=|document\s*\.\s*(?:cookie|domain|write|location)|window\s*\.\s*location|constructor\s*[\(`]|__proto__)" \
    "id:9941008,\
    phase:2,\
    t:none,\
    t:urlDecodeUni,\
    t:base64Decode,\
    t:htmlEntityDecode,\
    t:jsDecode,\
    t:removeNulls,\
    t:compressWhitespace,\
    t:lowercase,\
    block,\
    msg:'XSS Attack with Mixed Encoding (URL→Base64) Detected (Optimized)',\
    logdata:'Payload: %{MATCHED_VAR}',\
    severity:CRITICAL,\
    tag:'attack-xss',\
    tag:'attack-polyglot-encoding',\
    tag:'paranoia-level/4',\
    tag:'OWASP_CRS/XSS/MIXED',\
    setvar:'tx.xss_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}'"

# ----------------------------------------------------------------------------
# Rule 9941009: Mixed Encoding (Base64 → URL) - OPTIMIZED
# ----------------------------------------------------------------------------
SecRule ARGS_GET "@rx (?i)(?:<\s*(?:script|iframe|object|embed|svg|details|style|math|marquee|img|body)\b|on\w+\s*=|javascript:|data:\s*text\/html|vbscript:|(?:alert|confirm|prompt|eval|setTimeout|setInterval|Function)\s*\(.*?\)|(?:alert|confirm|prompt|eval)\s*`|\((?:alert|confirm|prompt|eval)\)\s*[\(`]|(?:alert|confirm|prompt|eval)\s*\.\s*(?:call|apply|bind)\s*\(|\.(?:call|apply|bind)\s*\(|['\"][^'\"]*\+[^'\"]*['\"]|self\s*\.\s*\w+\s*=|document\s*\.\s*(?:cookie|domain|write|location)|window\s*\.\s*location|constructor\s*[\(`]|__proto__)" \
    "id:9941009,\
    phase:2,\
    t:none,\
    t:base64Decode,\
    t:urlDecodeUni,\
    t:htmlEntityDecode,\
    t:jsDecode,\
    t:removeNulls,\
    t:compressWhitespace,\
    t:lowercase,\
    block,\
    msg:'XSS Attack with Mixed Encoding (Base64→URL) Detected (Optimized)',\
    logdata:'Payload: %{MATCHED_VAR}',\
    severity:CRITICAL,\
    tag:'attack-xss',\
    tag:'attack-polyglot-encoding',\
    tag:'paranoia-level/4',\
    tag:'OWASP_CRS/XSS/MIXED',\
    setvar:'tx.xss_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}'"

# ----------------------------------------------------------------------------
# Rule 9941010: Mixed Encoding in ARGS (POST/JSON) - OPTIMIZED
# ----------------------------------------------------------------------------
SecRule ARGS "@rx (?i)(?:<\s*(?:script|iframe|object|embed|svg|details|style|math|marquee|img|body)\b|on\w+\s*=|javascript:|data:\s*text\/html|vbscript:|(?:alert|confirm|prompt|eval|setTimeout|setInterval|Function)\s*\(.*?\)|(?:alert|confirm|prompt|eval)\s*`|\((?:alert|confirm|prompt|eval)\)\s*[\(`]|(?:alert|confirm|prompt|eval)\s*\.\s*(?:call|apply|bind)\s*\(|\.(?:call|apply|bind)\s*\(|['\"][^'\"]*\+[^'\"]*['\"]|self\s*\.\s*\w+\s*=|document\s*\.\s*(?:cookie|domain|write|location)|window\s*\.\s*location|constructor\s*[\(`]|__proto__)" \
    "id:9941010,\
    phase:2,\
    t:none,\
    t:urlDecodeUni,\
    t:base64Decode,\
    t:htmlEntityDecode,\
    t:jsDecode,\
    t:removeNulls,\
    t:compressWhitespace,\
    t:lowercase,\
    block,\
    msg:'XSS Attack with Mixed Encoding Detected - POST/JSON (Optimized)',\
    logdata:'Payload: %{MATCHED_VAR}',\
    severity:CRITICAL,\
    tag:'attack-xss',\
    tag:'attack-polyglot-encoding',\
    tag:'paranoia-level/4',\
    tag:'OWASP_CRS/XSS/MIXED',\
    setvar:'tx.xss_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}'"

# ============================================================================
# LAYER 6: REQUEST_URI PATH DETECTION - OPTIMIZED (WITH FULL DECODING)
# ============================================================================

# ----------------------------------------------------------------------------
# Rule 9941011: XSS Detection in REQUEST_URI - OPTIMIZED (Base64 + Full decode)
# ----------------------------------------------------------------------------
SecRule REQUEST_URI "@rx (?i)(?:<\s*(?:script|iframe|object|embed|svg|details|style|math|marquee|img|body|input|form)\b|on\w+\s*=|javascript:|data:\s*text\/html|(?:alert|confirm|prompt|eval|setTimeout|setInterval|Function)\s*\(.*?\)|(?:alert|confirm|prompt|eval)\s*`|\((?:alert|confirm|prompt|eval)\)\s*[\(`]|(?:alert|confirm|prompt|eval)\s*\.\s*(?:call|apply|bind)\s*\(|\.(?:call|apply|bind)\s*\(|['\"][^'\"]*\+[^'\"]*['\"]|self\s*\.\s*\w+\s*=|document\s*\.\s*(?:cookie|domain|write)|window\s*\.\s*location|constructor\s*[\(`]|__proto__)" \
    "id:9941011,\
    phase:2,\
    t:none,\
    t:urlDecodeUni,\
    t:base64Decode,\
    t:htmlEntityDecode,\
    t:jsDecode,\
    t:removeNulls,\
    t:compressWhitespace,\
    t:lowercase,\
    block,\
    msg:'XSS Attack Detected in URL Path (Optimized)',\
    logdata:'Path: %{REQUEST_URI}',\
    severity:CRITICAL,\
    tag:'attack-xss',\
    tag:'paranoia-level/4',\
    tag:'OWASP_CRS/XSS/OPTIMIZED',\
    setvar:'tx.xss_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}'"

# ============================================================================
# LAYER 7: SPECIAL BYPASS DETECTION - NEW PATTERNS FROM ANALYSIS
# ============================================================================

# ----------------------------------------------------------------------------
# Rule 9941012: String Concatenation XSS Detection - CRITICAL FIX
# Catches: javascript:setInterval('ale'+'rt(document.domain)')
# ----------------------------------------------------------------------------
SecRule ARGS|ARGS_GET|REQUEST_URI "@rx (?i)(?:['\"][^'\"]*\+[^'\"]*['\"][^'\"]*(?:alert|confirm|prompt|eval|ert\(|lert\(|irm\(|ompt\()|setInterval\s*\([^)]*\+|setTimeout\s*\([^)]*\+|Function\s*\([^)]*\+)" \
    "id:9941012,\
    phase:2,\
    t:none,\
    t:urlDecodeUni,\
    t:base64Decode,\
    t:htmlEntityDecode,\
    t:jsDecode,\
    t:removeNulls,\
    t:compressWhitespace,\
    t:lowercase,\
    block,\
    msg:'XSS String Concatenation Attack Detected (Optimized)',\
    logdata:'Payload: %{MATCHED_VAR}',\
    severity:CRITICAL,\
    tag:'attack-xss',\
    tag:'attack-string-concat',\
    tag:'paranoia-level/4',\
    tag:'OWASP_CRS/XSS/STRING_CONCAT',\
    setvar:'tx.xss_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}'"

# ----------------------------------------------------------------------------
# Rule 9941013: JS Context Injection Detection
# Catches: "));if(!self.x)self.x=!alert(document.domain)}catch(e){}//
# ----------------------------------------------------------------------------
SecRule ARGS|ARGS_GET|REQUEST_URI "@rx (?i)(?:self\s*\.\s*\w+\s*=\s*!?\s*(?:alert|confirm|prompt|eval)|catch\s*\([^)]*\)\s*\{[^}]*\}|try\s*\{[^}]*(?:alert|confirm|prompt|eval)|}\s*catch\s*\(|}\s*finally\s*\{|throw\s+\d+|=\s*!(?:alert|confirm|prompt|eval))" \
    "id:9941013,\
    phase:2,\
    t:none,\
    t:urlDecodeUni,\
    t:base64Decode,\
    t:htmlEntityDecode,\
    t:jsDecode,\
    t:removeNulls,\
    t:compressWhitespace,\
    t:lowercase,\
    block,\
    msg:'XSS JS Context Injection Detected (Optimized)',\
    logdata:'Payload: %{MATCHED_VAR}',\
    severity:CRITICAL,\
    tag:'attack-xss',\
    tag:'attack-js-context',\
    tag:'paranoia-level/4',\
    tag:'OWASP_CRS/XSS/JS_CONTEXT',\
    setvar:'tx.xss_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}'"

# ----------------------------------------------------------------------------
# Rule 9941014: HTML Entity XSS Detection (Pre-decoded check)
# Catches: <IMG SRC=j&#X41vascript:alert('test')>
# Note: Runs BEFORE htmlEntityDecode to catch raw entity patterns
# ----------------------------------------------------------------------------
SecRule ARGS|ARGS_GET|REQUEST_URI "@rx (?i)(?:&\#[xX]?[0-9a-fA-F]+;?\s*(?:a|j|v|s|c|r|i|p|t)|&(?:lt|gt|amp|quot|apos);?\s*(?:script|svg|img|body|iframe|on\w+|javascript|alert|confirm|prompt))" \
    "id:9941014,\
    phase:2,\
    t:none,\
    t:urlDecodeUni,\
    t:base64Decode,\
    t:removeNulls,\
    t:compressWhitespace,\
    t:lowercase,\
    block,\
    msg:'XSS HTML Entity Obfuscation Detected (Optimized)',\
    logdata:'Payload: %{MATCHED_VAR}',\
    severity:CRITICAL,\
    tag:'attack-xss',\
    tag:'attack-html-entity',\
    tag:'paranoia-level/4',\
    tag:'OWASP_CRS/XSS/HTML_ENTITY',\
    setvar:'tx.xss_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}'"

# ----------------------------------------------------------------------------
# Rule 9941015: DOM Sink Injection Detection
# Catches: window.location.href=, .innerHTML=, document.write(
# ----------------------------------------------------------------------------
SecRule ARGS|ARGS_GET|REQUEST_URI "@rx (?i)(?:\.(?:href|src|action|data|innerHTML|outerHTML|innerText|outerText|textContent|value)\s*=\s*['\"]?(?:javascript|data|vbscript|\/\/)|document\s*\.\s*(?:write|writeln)\s*\(|\.(?:insertAdjacentHTML|insertBefore|appendChild|replaceChild|cloneNode)\s*\(|eval\s*\(\s*(?:unescape|decodeURI|atob)\s*\(|new\s+Function\s*\()" \
    "id:9941015,\
    phase:2,\
    t:none,\
    t:urlDecodeUni,\
    t:base64Decode,\
    t:htmlEntityDecode,\
    t:jsDecode,\
    t:removeNulls,\
    t:compressWhitespace,\
    t:lowercase,\
    block,\
    msg:'XSS DOM Sink Injection Detected (Optimized)',\
    logdata:'Payload: %{MATCHED_VAR}',\
    severity:CRITICAL,\
    tag:'attack-xss',\
    tag:'attack-dom-sink',\
    tag:'paranoia-level/4',\
    tag:'OWASP_CRS/XSS/DOM_SINK',\
    setvar:'tx.xss_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}'"

# ============================================================================
# LAYER 8: ADDITIONAL BYPASS FIXES FROM 2026-01-15 ANALYSIS
# ============================================================================

# ----------------------------------------------------------------------------
# Rule 9941016: Function.call/apply/bind Detection (CRITICAL FIX)
# Catches: confirm.call(null,1), alert.apply(null,[1]), (alert)(1)
# ----------------------------------------------------------------------------
SecRule ARGS|ARGS_GET|REQUEST_URI "@rx (?i)(?:(?:alert|confirm|prompt|eval|Function)\s*\.\s*(?:call|apply|bind)\s*\(|(?:call|apply|bind)\s*\(\s*(?:null|this|window|self)\s*,\s*[^\)]*(?:alert|confirm|prompt|eval)|\(\s*(?:alert|confirm|prompt|eval)\s*\)\s*[\(\`]|\(\s*(?:alert|confirm|prompt|eval)\s*\)\s*\.?\s*\()" \
    "id:9941016,\
    phase:2,\
    t:none,\
    t:urlDecodeUni,\
    t:base64Decode,\
    t:htmlEntityDecode,\
    t:jsDecode,\
    t:removeNulls,\
    t:compressWhitespace,\
    t:lowercase,\
    block,\
    msg:'XSS Function.call/apply/bind Attack Detected',\
    logdata:'Payload: %{MATCHED_VAR}',\
    severity:CRITICAL,\
    tag:'attack-xss',\
    tag:'attack-function-invoke',\
    tag:'paranoia-level/4',\
    tag:'OWASP_CRS/XSS/FUNC_INVOKE',\
    setvar:'tx.xss_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}'"

# ----------------------------------------------------------------------------
# Rule 9941017: Template Literal XSS Detection
# Catches: alert`1`, prompt`XSS`, confirm`document.domain`
# ----------------------------------------------------------------------------
SecRule ARGS|ARGS_GET|REQUEST_URI "@rx (?i)(?:(?:alert|confirm|prompt|eval|Function|setInterval|setTimeout)\s*\`[^\`]*\`)" \
    "id:9941017,\
    phase:2,\
    t:none,\
    t:urlDecodeUni,\
    t:base64Decode,\
    t:htmlEntityDecode,\
    t:jsDecode,\
    t:removeNulls,\
    t:compressWhitespace,\
    t:lowercase,\
    block,\
    msg:'XSS Template Literal Attack Detected',\
    logdata:'Payload: %{MATCHED_VAR}',\
    severity:CRITICAL,\
    tag:'attack-xss',\
    tag:'attack-template-literal',\
    tag:'paranoia-level/4',\
    tag:'OWASP_CRS/XSS/TEMPLATE_LITERAL',\
    setvar:'tx.xss_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}'"

# ----------------------------------------------------------------------------
# Rule 9941018: Prototype Pollution XSS Detection
# Catches: __proto__[v-if]=_c.constructor('alert(1)')()
# ----------------------------------------------------------------------------
SecRule ARGS|ARGS_GET|REQUEST_URI "@rx (?i)(?:__proto__\s*\[|prototype\s*\[\s*['\"]|_c\s*\.\s*constructor\s*\(|\[\s*['\"]constructor['\"]?\s*\]|constructor\s*\(\s*['\"][^'\"]*(?:alert|confirm|prompt|eval|fetch|import))" \
    "id:9941018,\
    phase:2,\
    t:none,\
    t:urlDecodeUni,\
    t:base64Decode,\
    t:htmlEntityDecode,\
    t:jsDecode,\
    t:removeNulls,\
    t:compressWhitespace,\
    t:lowercase,\
    block,\
    msg:'XSS Prototype Pollution Attack Detected',\
    logdata:'Payload: %{MATCHED_VAR}',\
    severity:CRITICAL,\
    tag:'attack-xss',\
    tag:'attack-prototype-pollution',\
    tag:'paranoia-level/4',\
    tag:'OWASP_CRS/XSS/PROTOTYPE',\
    setvar:'tx.xss_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}'"

# ----------------------------------------------------------------------------
# Rule 9941019: Enhanced URLPath XSS with Triple Base64 Decode
# Catches: Base64-encoded XSS in URL path that needs multiple decode passes
# ----------------------------------------------------------------------------
SecRule REQUEST_URI "@rx (?i)(?:<\s*(?:script|iframe|object|embed|svg|img|body|input|form)\b|on\w+\s*=|javascript:|(?:alert|confirm|prompt|eval)\s*[\(\`]|(?:alert|confirm|prompt|eval)\s*\.\s*(?:call|apply)|document\s*\.\s*(?:cookie|domain|write)|window\s*\.\s*(?:location|open))" \
    "id:9941019,\
    phase:2,\
    t:none,\
    t:base64Decode,\
    t:base64Decode,\
    t:base64Decode,\
    t:urlDecodeUni,\
    t:htmlEntityDecode,\
    t:jsDecode,\
    t:removeNulls,\
    t:compressWhitespace,\
    t:lowercase,\
    block,\
    msg:'XSS Attack in URL Path with Deep Encoding Detected',\
    logdata:'Path: %{REQUEST_URI}',\
    severity:CRITICAL,\
    tag:'attack-xss',\
    tag:'attack-deep-encoding',\
    tag:'paranoia-level/4',\
    tag:'OWASP_CRS/XSS/URL_PATH_DEEP',\
    setvar:'tx.xss_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}'"

# ----------------------------------------------------------------------------
# Rule 9941020: Enhanced String Concatenation with Partial Function Names
# Catches: setInterval('ale'+'rt(...)', string concat with partial names
# Also catches: '-alert(1)// and similar JS context injections
# ----------------------------------------------------------------------------
SecRule ARGS|ARGS_GET|REQUEST_URI "@rx (?i)(?:(?:setInterval|setTimeout|Function)\s*\(\s*['\"][^'\"]*\+[^'\"]*['\"]|['\"](?:ale|ert|lert|pro|mpt|ompt|con|irm|firm|eva|val)\s*['\"][^'\"]*\+|['\"]?\s*-\s*(?:alert|confirm|prompt|eval)\s*\(|\(\s*['\"]\s*\+\s*['\"]\s*(?:rt|mpt|irm|val)\s*\())" \
    "id:9941020,\
    phase:2,\
    t:none,\
    t:urlDecodeUni,\
    t:base64Decode,\
    t:htmlEntityDecode,\
    t:jsDecode,\
    t:removeNulls,\
    t:compressWhitespace,\
    t:lowercase,\
    block,\
    msg:'XSS String Concatenation with Partial Function Detected',\
    logdata:'Payload: %{MATCHED_VAR}',\
    severity:CRITICAL,\
    tag:'attack-xss',\
    tag:'attack-string-concat-partial',\
    tag:'paranoia-level/4',\
    tag:'OWASP_CRS/XSS/CONCAT_PARTIAL',\
    setvar:'tx.xss_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}'"

# ----------------------------------------------------------------------------
# Rule 9941021: Inline Tag Breaking XSS Detection
# Catches: autof<x>ocus o<x>nfocus=alert<x>(1)// - tags inserted to break keywords
# ----------------------------------------------------------------------------
SecRule ARGS|ARGS_GET|REQUEST_URI "@rx (?i)(?:o\s*<[^>]*>\s*n\s*(?:focus|load|error|click|mouse)|a\s*<[^>]*>\s*l\s*<[^>]*>\s*e\s*<[^>]*>\s*r\s*<[^>]*>\s*t|s\s*<[^>]*>\s*c\s*<[^>]*>\s*r\s*<[^>]*>\s*i\s*<[^>]*>\s*p\s*<[^>]*>\s*t)" \
    "id:9941021,\
    phase:2,\
    t:none,\
    t:urlDecodeUni,\
    t:base64Decode,\
    t:removeNulls,\
    t:lowercase,\
    block,\
    msg:'XSS Inline Tag Breaking Attack Detected',\
    logdata:'Payload: %{MATCHED_VAR}',\
    severity:CRITICAL,\
    tag:'attack-xss',\
    tag:'attack-tag-breaking',\
    tag:'paranoia-level/4',\
    tag:'OWASP_CRS/XSS/TAG_BREAK',\
    setvar:'tx.xss_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}'"

# ----------------------------------------------------------------------------
# Rule 9941022: Full HTML Entity Encoded XSS Detection
# Catches: &lt;svg/onload&equals;alert(1)&gt;
# Note: Check for HTML entity patterns BEFORE htmlEntityDecode
# ----------------------------------------------------------------------------
SecRule ARGS|ARGS_GET|REQUEST_URI "@rx (?i)(?:\&(?:lt|#60|#x3c);?\s*(?:script|svg|img|body|iframe|object|embed)|\&(?:lt|#60|#x3c);?[^&]*on\w+\s*\&(?:equals|#61|#x3d);?|javascript\s*\&(?:colon|#58|#x3a);?)" \
    "id:9941022,\
    phase:2,\
    t:none,\
    t:urlDecodeUni,\
    t:base64Decode,\
    t:removeNulls,\
    t:compressWhitespace,\
    t:lowercase,\
    block,\
    msg:'XSS Full HTML Entity Encoding Attack Detected',\
    logdata:'Payload: %{MATCHED_VAR}',\
    severity:CRITICAL,\
    tag:'attack-xss',\
    tag:'attack-html-entity-full',\
    tag:'paranoia-level/4',\
    tag:'OWASP_CRS/XSS/HTML_ENTITY_FULL',\
    setvar:'tx.xss_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}'"

# ----------------------------------------------------------------------------
# Rule 9941023: Event Handler with Unusual Attribute Names
# Catches: <p only=1337 onmouseenter=...>, decoy attributes before real events
# ----------------------------------------------------------------------------
SecRule ARGS|ARGS_GET|REQUEST_URI "@rx (?i)(?:<\s*\w+[^>]*\s+\w+\s*=\s*[^>]*\s+on(?:mouse|key|focus|blur|load|error|click|touch|pointer|drag|scroll|wheel|copy|cut|paste|select|input|change|submit|reset|toggle|show|before|after)\w*\s*=)" \
    "id:9941023,\
    phase:2,\
    t:none,\
    t:urlDecodeUni,\
    t:base64Decode,\
    t:htmlEntityDecode,\
    t:jsDecode,\
    t:removeNulls,\
    t:compressWhitespace,\
    t:lowercase,\
    block,\
    msg:'XSS Event Handler with Decoy Attribute Detected',\
    logdata:'Payload: %{MATCHED_VAR}',\
    severity:CRITICAL,\
    tag:'attack-xss',\
    tag:'attack-event-decoy',\
    tag:'paranoia-level/4',\
    tag:'OWASP_CRS/XSS/EVENT_DECOY',\
    setvar:'tx.xss_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}'"

# ----------------------------------------------------------------------------
# Rule 9941024: JS Context Injection with Control Flow
# Catches: "));if(!self.x)self.x=!alert(...)}catch(e){}//
# ----------------------------------------------------------------------------
SecRule ARGS|ARGS_GET|REQUEST_URI "@rx (?i)(?:\)\s*\)\s*;?\s*(?:if|while|for|switch|try)\s*\(|\}?\s*catch\s*\(\s*\w*\s*\)\s*\{|=\s*!\s*(?:alert|confirm|prompt|eval)\s*\(|self\s*\.\s*\w+\s*=\s*!\s*(?:alert|confirm|prompt)|throw\s+(?:0|1|null|true|false)\s*;?\s*(?:alert|confirm|prompt))" \
    "id:9941024,\
    phase:2,\
    t:none,\
    t:urlDecodeUni,\
    t:base64Decode,\
    t:htmlEntityDecode,\
    t:jsDecode,\
    t:removeNulls,\
    t:compressWhitespace,\
    t:lowercase,\
    block,\
    msg:'XSS JS Context Injection with Control Flow Detected',\
    logdata:'Payload: %{MATCHED_VAR}',\
    severity:CRITICAL,\
    tag:'attack-xss',\
    tag:'attack-js-context-control',\
    tag:'paranoia-level/4',\
    tag:'OWASP_CRS/XSS/JS_CONTEXT_CTRL',\
    setvar:'tx.xss_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}'"

# ----------------------------------------------------------------------------
# Rule 9941025: Script Tag Injection with Null Byte or Special Chars
# Catches: <<scr[NULL]ipt/src=..., script tag with null bytes
# ----------------------------------------------------------------------------
SecRule ARGS|ARGS_GET|REQUEST_URI "@rx (?i)(?:<\s*<+\s*scr|<\s*scr\s*ipt|scr\x00ipt|script\s*/\s*src\s*=)" \
    "id:9941025,\
    phase:2,\
    t:none,\
    t:urlDecodeUni,\
    t:base64Decode,\
    t:lowercase,\
    block,\
    msg:'XSS Script Tag with Obfuscation Detected',\
    logdata:'Payload: %{MATCHED_VAR}',\
    severity:CRITICAL,\
    tag:'attack-xss',\
    tag:'attack-script-obfuscation',\
    tag:'paranoia-level/4',\
    tag:'OWASP_CRS/XSS/SCRIPT_OBFUSC',\
    setvar:'tx.xss_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}'"

# ============================================================================
# END OF OPTIMIZED GENERALIZED XSS RULES (v2 - 2026-01-15)
# ============================================================================

# ----------------------------------------------------------------------------
# Rule 9941052: Inline Tag Breaking in URLPath (CRITICAL FIX)
# Catches: autof<x>ocus o<x>nfocus=alert<x>(1)// in URL path
# Pattern: keyword with inline tags like <x> inserted to break detection
# ----------------------------------------------------------------------------
SecRule TX:xss_urlpath_raw|TX:xss_urlpath_decoded "@rx (?i)(?:o\s*<[^>]*>\s*n\s*(?:focus|load|error|click|wheel|mouse[a-z]*|key[a-z]*|touch[a-z]*|pointer[a-z]*|drag[a-z]*)|a\s*<[^>]*>\s*(?:l\s*<[^>]*>)?\s*e\s*<[^>]*>\s*r\s*<[^>]*>\s*t|on\s*<[^>]*>\s*(?:focus|load|error|click)|=\s*<[^>]*>\s*alert|autof\s*<[^>]*>\s*ocus)" \
    "id:9941052,\
    phase:2,\
    t:none,\
    t:lowercase,\
    block,\
    msg:'XSS Inline Tag Breaking in URL Path Detected',\
    logdata:'Decoded: %{TX.xss_urlpath_decoded}',\
    severity:CRITICAL,\
    tag:'attack-xss',\
    tag:'attack-tag-breaking-urlpath',\
    tag:'paranoia-level/4',\
    tag:'OWASP_CRS/XSS/TAG_BREAK_PATH',\
    setvar:'tx.xss_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}'"

# ----------------------------------------------------------------------------
# Rule 9941053: URL Decode URL Path Value
# Adds URL decoding to captured URL path for patterns like %3C = <
# ----------------------------------------------------------------------------
SecRule TX:xss_urlpath_raw "@rx .+" \
    "id:9941053,\
    phase:2,\
    log,\
    auditlog,\
    pass,\
    capture,\
    t:none,\
    t:urlDecodeUni,\
    t:removeNulls,\
    setvar:'tx.xss_urlpath_urldecoded=%{MATCHED_VAR}',\
    msg:'XSS: URL-decoded path value: %{TX.xss_urlpath_urldecoded}'"

# ----------------------------------------------------------------------------
# Rule 9941054: XSS Detection in URL-decoded URL Path
# Detects inline tag breaking in URL-decoded path values
# ----------------------------------------------------------------------------
SecRule TX:xss_urlpath_urldecoded "@rx (?i)(?:o\s*<[^>]*>\s*n\s*(?:focus|load|error|click|wheel|mouse[a-z]*|key[a-z]*)|<[^>]*>\s*(?:alert|confirm|prompt|eval)|autof\s*<[^>]*>\s*ocus|on\w+\s*=\s*(?:alert|confirm|prompt|eval)|=\s*<[^>]*>\s*(?:alert|confirm|prompt))" \
    "id:9941054,\
    phase:2,\
    t:none,\
    t:lowercase,\
    block,\
    msg:'XSS Inline Tag in URL-decoded Path Detected',\
    logdata:'Decoded: %{TX.xss_urlpath_urldecoded}',\
    severity:CRITICAL,\
    tag:'attack-xss',\
    tag:'attack-tag-breaking-url',\
    tag:'paranoia-level/4',\
    tag:'OWASP_CRS/XSS/TAG_BREAK_URL',\
    setvar:'tx.xss_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}'"
