# ============================================================================
# OWASP CRS - Generalized XSS Detection Rules (Fixed Syntax)
# Rule ID Range: 9941000-9941020
# ============================================================================
# Purpose: Structure-based XSS detection with intelligent nested decoding
#
# IMPORTANT: All rule IDs changed from 200xxx to 9941xxx to avoid conflicts
# with modsecurity.conf-recommended rules in the OWASP container.
#
# SYNTAX FIX: Chain rules restructured - disruptive actions (block) moved
# to chain starters as required by ModSecurity.
# ============================================================================

# ----------------------------------------------------------------------------
# CONFIGURATION VARIABLES
# ----------------------------------------------------------------------------
SecAction \
    "id:9941000,\
    phase:1,\
    nolog,\
    pass,\
    t:none,\
    setvar:'tx.xss_nested_decoding=1',\
    setvar:'tx.xss_max_decode_depth=2',\
    setvar:'tx.encoding_anomaly_score=3'"

# ============================================================================
# LAYER 1: STANDARD DECODING + DETECTION
# ============================================================================

# ----------------------------------------------------------------------------
# Rule 9941002: XSS Detection in ARGS_GET (URL Parameters)
# ----------------------------------------------------------------------------
SecRule ARGS_GET "@rx (?i)(?:<\s*(?:script|iframe|object|embed|svg|img|input|form|body|html|link|meta|base|style)\s*[^>]*(?:\s+on\w+\s*=|src\s*=\s*['\"]?\s*(?:javascript|data|vbscript|view-source)\s*:|style\s*=\s*['\"]?.*?expression)|<\s*[a-z0-9:-]+\s+[^>]*on\w+\s*=|(?:javascript|data|vbscript):\s*|(?:document\s*\.\s*(?:cookie|domain|write|location)|window\s*\.\s*location|eval|alert|prompt|confirm|setTimeout|setInterval|Function|constructor)\s*[\[\(]|<\s*script\s*[^>]*>)" \
    "id:9941002,\
    phase:2,\
    t:none,\
    t:base64Decode,\
    t:htmlEntityDecode,\
    t:compressWhitespace,\
    t:lowercase,\
    block,\
    msg:'XSS Attack Detected in URL Parameters (Custom)',\
    logdata:'Parameter: %{MATCHED_VAR_NAME}, Payload: %{MATCHED_VAR}',\
    severity:CRITICAL,\
    tag:'attack-xss',\
    tag:'paranoia-level/4',\
    tag:'OWASP_CRS/XSS/GENERALIZED',\
    setvar:'tx.xss_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}'"

# ----------------------------------------------------------------------------
# Rule 9941003: XSS Detection in ARGS (POST Body / Form Data / JSON)
# ----------------------------------------------------------------------------
SecRule ARGS "@rx (?i)(?:<\s*(?:script|iframe|object|embed|svg|img|input|form|body|html|link|meta|base|style)\s*[^>]*(?:\s+on\w+\s*=|src\s*=\s*['\"]?\s*(?:javascript|data|vbscript|view-source)\s*:|style\s*=\s*['\"]?.*?expression)|<\s*[a-z0-9:-]+\s+[^>]*on\w+\s*=|(?:javascript|data|vbscript):\s*|(?:document\s*\.\s*(?:cookie|domain|write|location)|window\s*\.\s*location|eval|alert|prompt|confirm|setTimeout|setInterval|Function|constructor)\s*[\[\(]|<\s*script\s*[^>]*>)" \
    "id:9941003,\
    phase:2,\
    t:none,\
    t:base64Decode,\
    t:htmlEntityDecode,\
    t:compressWhitespace,\
    t:lowercase,\
    block,\
    msg:'XSS Attack Detected in POST/JSON Data (Custom)',\
    logdata:'Parameter: %{MATCHED_VAR_NAME}, Payload: %{MATCHED_VAR}',\
    severity:CRITICAL,\
    tag:'attack-xss',\
    tag:'paranoia-level/4',\
    tag:'OWASP_CRS/XSS/GENERALIZED',\
    setvar:'tx.xss_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}'"

# ----------------------------------------------------------------------------
# Rule 9941004: XSS Detection in REQUEST_HEADERS (All Headers)
# ----------------------------------------------------------------------------
SecRule REQUEST_HEADERS "@rx (?i)(?:<\s*(?:script|iframe|object|embed|svg|img|input|form|body|html|link|meta|base|style)\s*[^>]*(?:\s+on\w+\s*=|src\s*=\s*['\"]?\s*(?:javascript|data|vbscript|view-source)\s*:|style\s*=\s*['\"]?.*?expression)|<\s*[a-z0-9:-]+\s+[^>]*on\w+\s*=|(?:javascript|data|vbscript):\s*|(?:document\s*\.\s*(?:cookie|domain|write|location)|window\s*\.\s*location|eval|alert|prompt|confirm|setTimeout|setInterval|Function|constructor)\s*[\[\(]|<\s*script\s*[^>]*>)" \
    "id:9941004,\
    phase:2,\
    t:none,\
    t:urlDecodeUni,\
    t:base64Decode,\
    t:htmlEntityDecode,\
    t:compressWhitespace,\
    t:lowercase,\
    block,\
    msg:'XSS Attack Detected in HTTP Headers (Custom)',\
    logdata:'Header: %{MATCHED_VAR_NAME}, Payload: %{MATCHED_VAR}',\
    severity:CRITICAL,\
    tag:'attack-xss',\
    tag:'paranoia-level/4',\
    tag:'OWASP_CRS/XSS/GENERALIZED',\
    setvar:'tx.xss_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}'"

# ============================================================================
# LAYER 2: NESTED BASE64 DETECTION (Simplified - Non-chained)
# ============================================================================
# These rules use double Base64 decode transformation

# ----------------------------------------------------------------------------
# Rule 9941005: Nested Base64 in ARGS_GET
# ----------------------------------------------------------------------------
SecRule ARGS_GET "@rx (?i)(?:<\s*(?:script|iframe|object|embed|svg)\s*|on\w+\s*=|javascript:|eval\s*\()" \
    "id:9941005,\
    phase:2,\
    t:none,\
    t:base64Decode,\
    t:base64Decode,\
    t:htmlEntityDecode,\
    t:lowercase,\
    block,\
    msg:'XSS Attack with Nested Base64 Detected - URL Param (Custom)',\
    logdata:'Payload: %{MATCHED_VAR}',\
    severity:CRITICAL,\
    tag:'attack-xss',\
    tag:'attack-encoding-evasion',\
    tag:'paranoia-level/4',\
    tag:'OWASP_CRS/XSS/NESTED',\
    setvar:'tx.xss_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}'"

# ----------------------------------------------------------------------------
# Rule 9941006: Nested Base64 in ARGS (POST/JSON)
# ----------------------------------------------------------------------------
SecRule ARGS "@rx (?i)(?:<\s*(?:script|iframe|object|embed|svg)\s*|on\w+\s*=|javascript:|eval\s*\()" \
    "id:9941006,\
    phase:2,\
    t:none,\
    t:base64Decode,\
    t:base64Decode,\
    t:htmlEntityDecode,\
    t:lowercase,\
    block,\
    msg:'XSS Attack with Nested Base64 Detected - POST/JSON (Custom)',\
    logdata:'Payload: %{MATCHED_VAR}',\
    severity:CRITICAL,\
    tag:'attack-xss',\
    tag:'attack-encoding-evasion',\
    tag:'paranoia-level/4',\
    tag:'OWASP_CRS/XSS/NESTED',\
    setvar:'tx.xss_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}'"

# ============================================================================
# LAYER 3: MIXED ENCODING DETECTION
# ============================================================================

# ----------------------------------------------------------------------------
# Rule 9941008: Mixed Encoding (URL → Base64) in ARGS_GET
# ----------------------------------------------------------------------------
SecRule ARGS_GET "@rx (?i)(?:<\s*(?:script|iframe|object|embed|svg)\s*|on\w+\s*=|javascript:|eval\s*\()" \
    "id:9941008,\
    phase:2,\
    t:none,\
    t:urlDecodeUni,\
    t:base64Decode,\
    t:htmlEntityDecode,\
    t:lowercase,\
    block,\
    msg:'XSS Attack with Mixed Encoding (URL→Base64) Detected (Custom)',\
    logdata:'Payload: %{MATCHED_VAR}',\
    severity:CRITICAL,\
    tag:'attack-xss',\
    tag:'attack-polyglot-encoding',\
    tag:'paranoia-level/4',\
    tag:'OWASP_CRS/XSS/MIXED',\
    setvar:'tx.xss_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}'"

# ----------------------------------------------------------------------------
# Rule 9941009: Mixed Encoding (Base64 → URL) in ARGS_GET
# ----------------------------------------------------------------------------
SecRule ARGS_GET "@rx (?i)(?:<\s*(?:script|iframe|object|embed|svg)\s*|on\w+\s*=|javascript:|eval\s*\()" \
    "id:9941009,\
    phase:2,\
    t:none,\
    t:base64Decode,\
    t:urlDecodeUni,\
    t:htmlEntityDecode,\
    t:lowercase,\
    block,\
    msg:'XSS Attack with Mixed Encoding (Base64→URL) Detected (Custom)',\
    logdata:'Payload: %{MATCHED_VAR}',\
    severity:CRITICAL,\
    tag:'attack-xss',\
    tag:'attack-polyglot-encoding',\
    tag:'paranoia-level/4',\
    tag:'OWASP_CRS/XSS/MIXED',\
    setvar:'tx.xss_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}'"

# ----------------------------------------------------------------------------
# Rule 9941010: Mixed Encoding in ARGS (POST/JSON)
# ----------------------------------------------------------------------------
SecRule ARGS "@rx (?i)(?:<\s*(?:script|iframe|object|embed|svg)\s*|on\w+\s*=|javascript:|eval\s*\()" \
    "id:9941010,\
    phase:2,\
    t:none,\
    t:urlDecodeUni,\
    t:base64Decode,\
    t:htmlEntityDecode,\
    t:lowercase,\
    block,\
    msg:'XSS Attack with Mixed Encoding Detected - POST/JSON (Custom)',\
    logdata:'Payload: %{MATCHED_VAR}',\
    severity:CRITICAL,\
    tag:'attack-xss',\
    tag:'attack-polyglot-encoding',\
    tag:'paranoia-level/4',\
    tag:'OWASP_CRS/XSS/MIXED',\
    setvar:'tx.xss_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}'"

# ============================================================================
# END OF FIXED GENERALIZED XSS RULES
# ============================================================================
